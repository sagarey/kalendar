name: Android Emulator Testing

on:
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      branch:
        description: 'è¦æµ‹è¯•çš„åˆ†æ”¯åç§°'
        required: false
        default: 'main'
        type: string

# ä¼˜åŒ–å¹¶å‘æŽ§åˆ¶ï¼Œé¿å…é‡å¤è¿è¡Œ
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  emulator-test:
    runs-on: ubuntu-latest
    timeout-minutes: 35  # 4æ ¸å¿ƒä¼˜åŒ–åŽï¼Œç¼©çŸ­è¶…æ—¶æ—¶é—´
    env:
      # ä¼˜åŒ– Gradle æ€§èƒ½ - ubuntu-latest 4æ ¸å¿ƒé…ç½®
      GRADLE_OPTS: -Dorg.gradle.daemon=true -Dorg.gradle.parallel=true -Dorg.gradle.workers.max=4 -Dorg.gradle.configureondemand=true -Dorg.gradle.caching=true -Dkotlin.incremental=true -Dkotlin.incremental.android=true -Dkotlin.compiler.execution.strategy=in-process -Dorg.gradle.jvmargs="-Xmx4g -XX:+UseG1GC -XX:MaxGCPauseMillis=100"
      # Android ç›¸å…³çŽ¯å¢ƒå˜é‡ - æœ€æ–°é…ç½®
      ANDROID_COMPILE_SDK: 34
      ANDROID_BUILD_TOOLS: 34.0.0
      ANDROID_SDK_TOOLS: 9477386
      API_LEVEL: 34
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          ref: ${{ github.event.inputs.branch || github.ref }}

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4
        with:
          cache-read-only: false
          cache-encryption-key: ${{ secrets.GRADLE_ENCRYPTION_KEY || '' }}

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Pre-download dependencies
        timeout-minutes: 10  # ä¾èµ–ä¸‹è½½è¶…æ—¶æŽ§åˆ¶
        run: |
          echo "ðŸ“¥ ä¸‹è½½ä¾èµ–..."
          echo "ðŸ’¾ å†…å­˜: $(free -h | grep '^Mem:' | awk '{print $2}') | CPU: $(nproc)æ ¸"
          ./gradlew dependencies --stacktrace
          echo "âœ… ä¾èµ–ä¸‹è½½å®Œæˆ"

      - name: Cache Android SDK
        id: cache-android-sdk
        uses: actions/cache@v4
        continue-on-error: true
        with:
          path: |
            ~/.android
          key: ${{ runner.os }}-android-sdk-${{ env.API_LEVEL }}-v3
          restore-keys: |
            ${{ runner.os }}-android-sdk-${{ env.API_LEVEL }}-v2
            ${{ runner.os }}-android-sdk-${{ env.API_LEVEL }}-
            ${{ runner.os }}-android-sdk-
      
      - name: Cache Status Summary
        run: |
          echo "ðŸ“‹ ç¼“å­˜çŠ¶æ€æ±‡æ€»:"
          # Gradle ç¼“å­˜ (setup-gradle å†…ç½®)
          echo "  ðŸ—ï¸ Gradle: ç”± setup-gradle ç®¡ç†"
          
          # Android SDK ç¼“å­˜
          if [ "${{ steps.cache-android-sdk.outputs.cache-hit }}" == "true" ]; then
            echo "  âœ… Android SDK: ç¼“å­˜å‘½ä¸­"
          else
            echo "  ðŸ“¥ Android SDK: éœ€è¦ä¸‹è½½"
          fi
          
          # æ˜¾ç¤ºç¼“å­˜é”®ä¿¡æ¯
          echo "  ðŸ”‘ SDK ç¼“å­˜é”®: ${{ runner.os }}-android-sdk-${{ env.API_LEVEL }}-v3"
          
          # æ£€æŸ¥å®žé™…è·¯å¾„
          echo "ðŸ“‚ ç¼“å­˜è·¯å¾„æ£€æŸ¥:"
          echo "  Gradle: $(ls -la ~/.gradle 2>/dev/null | wc -l) ä¸ªæ–‡ä»¶/ç›®å½•"
          echo "  Android: $(ls -la ~/.android 2>/dev/null | wc -l) ä¸ªæ–‡ä»¶/ç›®å½•"

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Setup Android Environment
        run: |
          echo "ðŸš€ é…ç½® Android çŽ¯å¢ƒ..."
          
          # å¯ç”¨ KVM ç¡¬ä»¶åŠ é€Ÿ
          echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666", OPTIONS+="static_node=kvm"' | sudo tee /etc/udev/rules.d/99-kvm4all.rules > /dev/null
          sudo udevadm control --reload-rules
          sudo udevadm trigger --name-match=kvm
          
          # æ£€æŸ¥ KVM æ”¯æŒ
          if [ -r /dev/kvm ]; then
            echo "âœ… KVM åŠ é€Ÿå·²å¯ç”¨"
          else
            echo "âš ï¸ KVM åŠ é€Ÿä¸å¯ç”¨"
          fi
          
          # å¯åŠ¨ ADB æœåŠ¡
          adb start-server
          
          # è®¾ç½®å›¾å½¢çŽ¯å¢ƒ
          echo "QT_QPA_PLATFORM=offscreen" >> $GITHUB_ENV
          echo "DISPLAY=:99" >> $GITHUB_ENV

      - name: Cache Android Emulator
        id: cache-emulator
        uses: actions/cache@v4
        continue-on-error: true
        with:
          path: |
            ~/.android/avd
          key: ${{ runner.os }}-avd-api${{ env.API_LEVEL }}-nexus6-default-v3
          restore-keys: |
            ${{ runner.os }}-avd-api${{ env.API_LEVEL }}-nexus6-default-v2
            ${{ runner.os }}-avd-api${{ env.API_LEVEL }}-nexus6-
            ${{ runner.os }}-avd-api${{ env.API_LEVEL }}-
      


      - name: Start Android Emulator
        timeout-minutes: 12  # ç¼©çŸ­è¶…æ—¶æ—¶é—´ï¼Œå¿«é€Ÿå¤±è´¥
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: ${{ env.API_LEVEL }}
          target: default  # ä½¿ç”¨é»˜è®¤ç›®æ ‡ï¼Œæ›´ç¨³å®š
          arch: x86_64
          profile: Nexus 6
          avd-name: test-api${{ env.API_LEVEL }}
          force-avd-creation: false  # å°è¯•å¤ç”¨å·²æœ‰ AVD
          emulator-options: -no-window -gpu swiftshader_indirect -noaudio -no-boot-anim -camera-back none -camera-front none -memory 2048
          disable-animations: true
          disable-spellchecker: true
          disable-linux-hw-accel: false
          working-directory: ./
          script: |
            echo "ðŸ“± å¯åŠ¨æ¨¡æ‹Ÿå™¨..."
            
            # ç­‰å¾…æ¨¡æ‹Ÿå™¨è¿›ç¨‹å¯åŠ¨
            echo "â³ ç­‰å¾…æ¨¡æ‹Ÿå™¨è¿›ç¨‹å¯åŠ¨..."
            sleep 10
            
            # æ£€æŸ¥æ¨¡æ‹Ÿå™¨çŠ¶æ€
            echo "ðŸ” æ£€æŸ¥æ¨¡æ‹Ÿå™¨çŠ¶æ€..."
            adb devices
            
            # ç­‰å¾…è®¾å¤‡è¿žæŽ¥ï¼Œä½¿ç”¨ while å¾ªçŽ¯æ›¿ä»£ for å¾ªçŽ¯
            echo "â³ ç­‰å¾… ADB è¿žæŽ¥..."
            ADB_CONNECTED=false
            attempt=1
            max_attempts=8
            
            while [ $attempt -le $max_attempts ]; do
              echo "ðŸ” è¿žæŽ¥å°è¯• $attempt/$max_attempts..."
              adb devices
              if adb devices | grep -q "emulator.*device"; then
                echo "âœ… ADB å·²è¿žæŽ¥ ($attempt/$max_attempts)"
                ADB_CONNECTED=true
                break
              else
                echo "â³ ç­‰å¾…è¿žæŽ¥... ($attempt/$max_attempts)"
                if [ $attempt -eq 4 ]; then
                  echo "ðŸ”„ ä¸­é€”é‡å¯ ADB æœåŠ¡..."
                  adb kill-server 2>/dev/null || true
                  sleep 2
                  adb start-server 2>/dev/null || true
                  sleep 3
                fi
                sleep 5
              fi
              attempt=$((attempt + 1))
            done
            
            if [ "$ADB_CONNECTED" = false ]; then
              echo "âŒ ADB è¿žæŽ¥æœ€ç»ˆå¤±è´¥"
              echo "ðŸ“Š æœ€ç»ˆçŠ¶æ€æ£€æŸ¥:"
              adb devices
              echo "ðŸ”§ æœ€åŽå°è¯•é‡å¯ ADB..."
              adb kill-server 2>/dev/null || true
              sleep 2
              adb start-server 2>/dev/null || true
              sleep 3
              adb devices
              exit 1
            fi
            
            # èŽ·å–è®¾å¤‡åç§°
            DEVICE=$(adb devices | grep emulator | cut -f1 | head -1)
            if [ -z "$DEVICE" ]; then
              echo "âŒ æœªæ‰¾åˆ°æ¨¡æ‹Ÿå™¨è®¾å¤‡"
              echo "å½“å‰è®¾å¤‡åˆ—è¡¨:"
              adb devices
              exit 1
            fi
            echo "ðŸŽ¯ è¿žæŽ¥åˆ°è®¾å¤‡: $DEVICE"
            
            # ç­‰å¾…ç³»ç»Ÿå®Œå…¨å¯åŠ¨
            echo "â³ ç­‰å¾…ç³»ç»Ÿå¯åŠ¨..."
            BOOT_CHECK_COUNT=0
            while [ $BOOT_CHECK_COUNT -lt 60 ]; do
              BOOT_STATUS=$(adb -s $DEVICE shell getprop sys.boot_completed 2>/dev/null || echo "")
              if [ "$BOOT_STATUS" = "1" ]; then
                echo "âœ… ç³»ç»Ÿå¯åŠ¨å®Œæˆ"
                break
              else
                echo "â³ å¯åŠ¨æ£€æŸ¥ $((BOOT_CHECK_COUNT + 1))/60..."
                sleep 3
                BOOT_CHECK_COUNT=$((BOOT_CHECK_COUNT + 1))
              fi
            done
            
            if [ $BOOT_CHECK_COUNT -eq 60 ]; then
              echo "âŒ ç³»ç»Ÿå¯åŠ¨è¶…æ—¶"
              echo "è®¾å¤‡çŠ¶æ€:"
              adb -s $DEVICE shell getprop sys.boot_completed 2>/dev/null || echo "æ— æ³•èŽ·å–å¯åŠ¨çŠ¶æ€"
              exit 1
            fi
            
            # ä¼˜åŒ–æ€§èƒ½è®¾ç½®
            echo "âš¡ ä¼˜åŒ–æ€§èƒ½..."
            adb -s $DEVICE shell settings put global window_animation_scale 0 2>/dev/null || echo "è®¾ç½®åŠ¨ç”»ç¼©æ”¾å¤±è´¥"
            adb -s $DEVICE shell settings put global transition_animation_scale 0 2>/dev/null || echo "è®¾ç½®è¿‡æ¸¡åŠ¨ç”»å¤±è´¥"
            adb -s $DEVICE shell settings put global animator_duration_scale 0 2>/dev/null || echo "è®¾ç½®åŠ¨ç”»æ—¶é•¿å¤±è´¥"
            
            # éªŒè¯æ¨¡æ‹Ÿå™¨çŠ¶æ€
            ANDROID_VERSION=$(adb -s $DEVICE shell getprop ro.build.version.release 2>/dev/null || echo "Unknown")
            ANDROID_API=$(adb -s $DEVICE shell getprop ro.build.version.sdk 2>/dev/null || echo "Unknown")
            echo "âœ… æ¨¡æ‹Ÿå™¨å°±ç»ª - Android $ANDROID_VERSION (API $ANDROID_API)"
            
            # æœ€ç»ˆçŠ¶æ€éªŒè¯
            echo "ðŸ“Š æœ€ç»ˆçŠ¶æ€éªŒè¯:"
            echo "  è®¾å¤‡: $DEVICE"
            echo "  ADB çŠ¶æ€: $(adb get-state 2>/dev/null || echo 'unknown')"
            echo "  å¯åŠ¨å®Œæˆ: $(adb -s $DEVICE shell getprop sys.boot_completed 2>/dev/null || echo 'unknown')"

      - name: Emulator Diagnostics
        if: failure()
        run: |
          echo "ðŸ” æ¨¡æ‹Ÿå™¨è¯Šæ–­ä¿¡æ¯:"
          echo "ðŸ“± è®¾å¤‡åˆ—è¡¨:"
          adb devices
          echo ""
          echo "ðŸ”§ ADB ç‰ˆæœ¬:"
          adb version
          echo ""
          echo "ðŸ’¾ ç³»ç»Ÿèµ„æº:"
          free -h
          echo ""
          echo "ðŸ—ï¸ è¿›ç¨‹ä¿¡æ¯:"
          ps aux | grep -E "(emulator|qemu)" | head -5
          echo ""
          echo "ðŸ“‚ æ¨¡æ‹Ÿå™¨æ–‡ä»¶:"
          ls -la ~/.android/avd/ 2>/dev/null || echo "æ— æ³•è®¿é—® AVD ç›®å½•"

      - name: Cache build outputs
        id: cache-build
        uses: actions/cache@v4
        continue-on-error: true
        with:
          path: |
            app/build/intermediates
            app/build/tmp
            app/build/generated
            build/kotlin
            .gradle/kotlin-dsl
          key: ${{ runner.os }}-build-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties', '**/*.kt', '**/*.java') }}
          restore-keys: |
            ${{ runner.os }}-build-
      


      - name: Final Cache Status
        run: |
          echo "ðŸ“Š æœ€ç»ˆç¼“å­˜æŠ¥å‘Š:"
          echo "  ðŸ—ï¸ Gradle: ç”± setup-gradle è‡ªåŠ¨ç®¡ç†"
          echo "  ðŸ“± Android SDK: ${{ steps.cache-android-sdk.outputs.cache-hit == 'true' && 'âœ… å·²ç¼“å­˜' || 'ðŸ“¥ æ–°ä¸‹è½½' }}"
          echo "  ðŸŽ® æ¨¡æ‹Ÿå™¨AVD: ${{ steps.cache-emulator.outputs.cache-hit == 'true' && 'âœ… å·²ç¼“å­˜' || 'ðŸ“¥ æ–°åˆ›å»º' }}"
          echo "  ðŸ”¨ æž„å»ºäº§ç‰©: ${{ steps.cache-build.outputs.cache-hit == 'true' && 'âœ… å·²ç¼“å­˜' || 'ðŸ“¥ é¦–æ¬¡æž„å»º' }}"
          
          # æ˜¾ç¤ºç¼“å­˜å¤§å°
          echo "ðŸ“ ç¼“å­˜å¤§å°æ£€æŸ¥:"
          echo "  ~/.gradle: $(du -sh ~/.gradle 2>/dev/null | cut -f1 || echo 'æœªæ‰¾åˆ°')"
          echo "  ~/.android: $(du -sh ~/.android 2>/dev/null | cut -f1 || echo 'æœªæ‰¾åˆ°')"

      - name: Build and Install APK
        timeout-minutes: 12  # æž„å»ºè¶…æ—¶æŽ§åˆ¶
        run: |
          echo "ðŸ”¨ æž„å»º APK..."
          BUILD_START_TIME=$(date +%s)
          
          if ./gradlew assembleFossDebug --configure-on-demand --stacktrace --build-cache; then
            BUILD_END_TIME=$(date +%s)
            BUILD_DURATION=$((BUILD_END_TIME - BUILD_START_TIME))
            echo "âœ… æž„å»ºæˆåŠŸ (${BUILD_DURATION}s)"
          else
            echo "âŒ æž„å»ºå¤±è´¥"
            exit 1
          fi
          
          # å®‰è£… APK
          APK_PATH="app/build/outputs/apk/foss/debug/app-foss-debug.apk"
          if [ -f "$APK_PATH" ]; then
            APK_SIZE=$(du -h "$APK_PATH" | cut -f1)
            echo "ðŸ“± å®‰è£… APK ($APK_SIZE)..."
            
            if adb install -r -t "$APK_PATH" 2>/dev/null || adb install -r -t "$APK_PATH"; then
              echo "âœ… APK å®‰è£…æˆåŠŸ"
            else
              echo "âŒ APK å®‰è£…å¤±è´¥"
              exit 1
            fi
          else
            echo "âŒ APK æ–‡ä»¶ä¸å­˜åœ¨"
            exit 1
          fi

      - name: Test and Verify Installation
        timeout-minutes: 5  # æµ‹è¯•éªŒè¯è¶…æ—¶æŽ§åˆ¶
        run: |
          echo "ðŸ” éªŒè¯åº”ç”¨..."
          
          # æ£€æŸ¥å®‰è£…
          PACKAGE_NAME="org.fossify.calendar"
          if adb shell pm list packages | grep -q "$PACKAGE_NAME"; then
            echo "âœ… åº”ç”¨å·²å®‰è£…"
          else
            echo "âŒ åº”ç”¨æœªæ‰¾åˆ°"
            exit 1
          fi
          
          # å¯åŠ¨åº”ç”¨
          echo "ðŸš€ å¯åŠ¨åº”ç”¨..."
          adb shell am start -n "$PACKAGE_NAME/.activities.MainActivity" 2>/dev/null || \
          adb shell am start -n "$PACKAGE_NAME/.activities.SplashActivity" 2>/dev/null || true
          
          sleep 2
          
          # æˆªå›¾éªŒè¯
          if adb shell screencap -p /sdcard/screenshot.png && adb pull /sdcard/screenshot.png ./screenshot.png 2>/dev/null; then
            echo "âœ… æˆªå›¾æˆåŠŸ ($(du -h ./screenshot.png | cut -f1))"
            adb shell rm /sdcard/screenshot.png 2>/dev/null || true
          else
            echo "âš ï¸ æˆªå›¾å¤±è´¥"
          fi
          
          echo "âœ… æµ‹è¯•å®Œæˆ"

      - name: Upload Test Results and Build Logs
        uses: actions/upload-artifact@v4
        with:
          name: android-test-results-${{ github.run_number }}
          path: |
            screenshot.png
            app_logs.txt
            app/build/outputs/apk/foss/debug/app-foss-debug.apk
            build/reports/**/*
            app/build/reports/**/*
            gradle-build-scan-*.txt
          retention-days: 30

      - name: Test Summary
        if: always()
        run: |
          BRANCH_NAME="${{ github.event.inputs.branch || github.ref_name }}"
          
          echo "## ðŸ§ª Android æ¨¡æ‹Ÿå™¨æµ‹è¯•" >> $GITHUB_STEP_SUMMARY
          echo "- **åˆ†æ”¯**: $BRANCH_NAME" >> $GITHUB_STEP_SUMMARY
          echo "- **æäº¤**: ${GITHUB_SHA:0:7}" >> $GITHUB_STEP_SUMMARY
          echo "- **Android API**: ${{ env.API_LEVEL }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # æ£€æŸ¥ç»“æžœ
          if [ -f "screenshot.png" ]; then
            echo "### âœ… æµ‹è¯•æˆåŠŸ" >> $GITHUB_STEP_SUMMARY
            echo "- APK å®‰è£…å¹¶å¯åŠ¨æˆåŠŸ" >> $GITHUB_STEP_SUMMARY
            echo "- æˆªå›¾: $(du -h screenshot.png | cut -f1)" >> $GITHUB_STEP_SUMMARY
          else
            echo "### âŒ æµ‹è¯•å¤±è´¥" >> $GITHUB_STEP_SUMMARY
            echo "è¯¦è§è¿è¡Œæ—¥å¿—" >> $GITHUB_STEP_SUMMARY
          fi
