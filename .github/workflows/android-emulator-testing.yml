name: Android Emulator Testing

on:
  workflow_dispatch:
    inputs:
      branch:
        description: 'Target branch to test'
        required: false
        default: 'main'

env:
  API_LEVEL: 34
  TARGET: default
  ARCH: x86_64
  PROFILE: pixel_3a

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  emulator-test:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    env:
      # ç®€åŒ–çš„ Gradle é…ç½® - ç¨³å®šä¸ºä¸»
      GRADLE_OPTS: -Xmx6g -XX:+UseG1GC
      # Android ç›¸å…³ç¯å¢ƒå˜é‡
      ANDROID_BUILD_TOOLS: 34.0.0
      ANDROID_HOME: /usr/local/lib/android/sdk
      ANDROID_AVD_HOME: /home/runner/.android/avd
      # AVDæ€§èƒ½ä¼˜åŒ–ç¯å¢ƒå˜é‡
      AVD_CPU_CORES: 2
      AVD_RAM_SIZE: 4096
      AVD_HEAP_SIZE: 256
      AVD_STORAGE_SIZE: 4096MB

    steps:
      # ============================================
      # é˜¶æ®µ1: ä»£ç è·å–
      # ============================================
      
      - name: Checkout
        uses: actions/checkout@v5
        with:
          ref: ${{ github.event.inputs.branch || github.ref }}
          fetch-depth: 1

      # ============================================
      # é˜¶æ®µ2: åŸºç¡€ç¯å¢ƒè®¾ç½®
      # ============================================

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'
        
      - name: Setup Gradle Permissions
        run: |
          chmod +x gradlew
        
      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4
        with:
          cache-read-only: false

      # ============================================
      # é˜¶æ®µ3: Android SDK è®¾ç½®
      # ============================================

      - name: Setup Android Environment
        run: |
          echo "QT_QPA_PLATFORM=offscreen" >> $GITHUB_ENV
          echo "DISPLAY=:99" >> $GITHUB_ENV
          
          # æ£€æŸ¥ç³»ç»Ÿèµ„æºå’ŒKVMåŠ é€Ÿæ”¯æŒ
          echo "ğŸ“Š ç³»ç»Ÿèµ„æºä¿¡æ¯:"
          echo "CPUæ ¸å¿ƒæ•°: $(nproc)"
          echo "å†…å­˜æ€»é‡: $(free -h | grep '^Mem' | awk '{print $2}')"
          echo "å¯ç”¨å†…å­˜: $(free -h | grep '^Mem' | awk '{print $7}')"
          echo "ç£ç›˜ç©ºé—´: $(df -h / | tail -1 | awk '{print $4}')"
          
          echo "ğŸš€ æ£€æŸ¥KVMåŠ é€Ÿæ”¯æŒ..."
          if [ -e /dev/kvm ]; then
            echo "âœ… KVMåŠ é€Ÿå¯ç”¨"
            sudo chown runner:runner /dev/kvm
          else
            echo "âš ï¸ KVMåŠ é€Ÿä¸å¯ç”¨ï¼Œä½¿ç”¨è½¯ä»¶æ¨¡æ‹Ÿ"
          fi

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3
        with:
          packages: tools platform-tools platforms;android-${{ env.API_LEVEL }} build-tools;${{ env.ANDROID_BUILD_TOOLS }} system-images;android-${{ env.API_LEVEL }};${{ env.TARGET }};${{ env.ARCH }} emulator

      - name: Create AVD
        run: |
          echo "ğŸ” æ£€æŸ¥å¯ç”¨çš„ç³»ç»Ÿé•œåƒ..."
          sdkmanager --list_installed | grep "system-images" || echo "æœªæ‰¾åˆ°å·²å®‰è£…çš„ç³»ç»Ÿé•œåƒ"
          
          SYSTEM_IMAGE="system-images;android-${{ env.API_LEVEL }};${{ env.TARGET }};${{ env.ARCH }}"
          AVD_NAME="test-api${{ env.API_LEVEL }}"
          
          echo "ğŸ“± åˆ›å»ºAVD: $AVD_NAME"
          echo "ğŸ“¦ ä½¿ç”¨ç³»ç»Ÿé•œåƒ: $SYSTEM_IMAGE"
          
          # åˆ›å»ºAVD
          echo "no" | avdmanager create avd \
            --force \
            --name "$AVD_NAME" \
            --abi "${{ env.TARGET }}/${{ env.ARCH }}" \
            --package "$SYSTEM_IMAGE" \
            --device "${{ env.PROFILE }}" || {
            echo "âŒ AVDåˆ›å»ºå¤±è´¥ï¼Œå°è¯•ä½¿ç”¨å¤‡é€‰é…ç½®..."
            echo "ğŸ“‹ å¯ç”¨è®¾å¤‡åˆ—è¡¨:"
            avdmanager list device || echo "æ— æ³•è·å–è®¾å¤‡åˆ—è¡¨"
            echo "ğŸ“‹ å¯ç”¨ç³»ç»Ÿé•œåƒ:"
            avdmanager list target || echo "æ— æ³•è·å–ç›®æ ‡åˆ—è¡¨"
            exit 1
          }
          
          echo "âœ… AVDåˆ›å»ºå®Œæˆï¼Œæ£€æŸ¥ç”Ÿæˆçš„æ–‡ä»¶..."
          
          # æ£€æŸ¥AVDç›®å½•å’Œæ–‡ä»¶
          echo "ğŸ“ AVDç›®å½•å†…å®¹:"
          ls -la "$ANDROID_AVD_HOME/" || echo "æ— æ³•è®¿é—®AVDç›®å½•"
          
          # ç­‰å¾…é…ç½®æ–‡ä»¶ç”Ÿæˆ
          sleep 2
          
          # æŸ¥æ‰¾å®é™…çš„é…ç½®æ–‡ä»¶è·¯å¾„
          AVD_CONFIG="$ANDROID_AVD_HOME/${AVD_NAME}.avd/config.ini"
          echo "ğŸ” æŸ¥æ‰¾é…ç½®æ–‡ä»¶: $AVD_CONFIG"
          
          if [ -f "$AVD_CONFIG" ]; then
            echo "âœ… æ‰¾åˆ°é…ç½®æ–‡ä»¶ï¼Œå¼€å§‹ä¼˜åŒ–..."
            echo "âš™ï¸ ä½¿ç”¨ç¯å¢ƒå˜é‡ä¼˜åŒ–AVDæ€§èƒ½é…ç½®..."
            echo "hw.cpu.ncore=$AVD_CPU_CORES" >> "$AVD_CONFIG"
            echo "hw.ramSize=$AVD_RAM_SIZE" >> "$AVD_CONFIG"
            echo "hw.gpu.enabled=yes" >> "$AVD_CONFIG"
            echo "hw.gpu.mode=swiftshader_indirect" >> "$AVD_CONFIG"
            echo "hw.keyboard=yes" >> "$AVD_CONFIG"
            echo "disk.dataPartition.size=$AVD_STORAGE_SIZE" >> "$AVD_CONFIG"
            echo "vm.heapSize=$AVD_HEAP_SIZE" >> "$AVD_CONFIG"
            echo "âœ… AVDé…ç½®å®Œæˆ: ${AVD_CPU_CORES}æ ¸å¿ƒ, ${AVD_RAM_SIZE}MBå†…å­˜"
          else
            echo "âš ï¸ é…ç½®æ–‡ä»¶æœªåœ¨é¢„æœŸä½ç½®æ‰¾åˆ°ï¼Œå°è¯•å…¶ä»–ä½ç½®..."
            echo "ğŸ” æœç´¢æ‰€æœ‰å¯èƒ½çš„é…ç½®æ–‡ä»¶ä½ç½®:"
            find "$ANDROID_AVD_HOME" -name "config.ini" 2>/dev/null || echo "æœªæ‰¾åˆ°ä»»ä½•config.iniæ–‡ä»¶"
            find "$HOME/.android" -name "config.ini" 2>/dev/null || echo "åœ¨.androidç›®å½•æœªæ‰¾åˆ°config.ini"
            
            # åˆ—å‡ºåˆ›å»ºçš„AVD
            echo "ğŸ“‹ å·²åˆ›å»ºçš„AVDåˆ—è¡¨:"
            avdmanager list avd || echo "æ— æ³•è·å–AVDåˆ—è¡¨"
            
            echo "âš ï¸ è·³è¿‡AVDæ€§èƒ½ä¼˜åŒ–ï¼Œä½¿ç”¨é»˜è®¤é…ç½®"
          fi

      # ============================================
      # é˜¶æ®µ4: APK æ„å»ºæ€§èƒ½ä¼˜åŒ–
      # ============================================

      - name: Build APK
        timeout-minutes: 15
        run: |
          echo "ğŸš€ å¼€å§‹APKæ„å»º..."
          echo "ğŸ“‹ Gradleç‰ˆæœ¬ä¿¡æ¯:"
          ./gradlew --version
          
          echo "ğŸ”§ å¼€å§‹æ¸…ç†å’Œæ„å»º..."
          ./gradlew clean
          ./gradlew assembleFossDebug --stacktrace --info

      # ============================================
      # é˜¶æ®µ5: æ¨¡æ‹Ÿå™¨æµ‹è¯• + æˆªå›¾
      # ============================================

      - name: Android Emulator Testing with Screenshots
        timeout-minutes: 20
        continue-on-error: false
        uses: reactivecircus/android-emulator-runner@v2
        env:
          ANDROID_AVD_HOME: ${{ env.ANDROID_AVD_HOME }}
        with:
          api-level: ${{ env.API_LEVEL }}
          target: ${{ env.TARGET }}
          arch: ${{ env.ARCH }}
          profile: ${{ env.PROFILE }}
          avd-name: test-api${{ env.API_LEVEL }}
          force-avd-creation: false
          emulator-options: -no-window -gpu swiftshader_indirect -noaudio -no-boot-anim -camera-back none -camera-front none -memory ${{ env.AVD_RAM_SIZE }} -cores ${{ env.AVD_CPU_CORES }} -accel on
          disable-animations: true
          disable-spellchecker: true
          disable-linux-hw-accel: false
          emulator-build: 7425822
          script: adb uninstall org.fossify.calendar.debug || true && adb install -r app/build/outputs/apk/foss/debug/kalendar-app-foss-debug.apk && adb shell pm list packages | grep org.fossify.calendar.debug && sleep 8 && adb shell screencap -p /sdcard/screenshot.png && adb pull /sdcard/screenshot.png calendar_running_screenshot.png

      - name: Upload APK and Screenshot
        uses: actions/upload-artifact@v4
        with:
          name: android-test-results-${{ github.run_number }}
          path: |
            app/build/outputs/apk/foss/debug/kalendar-app-foss-debug.apk
            calendar_running_screenshot.png
          retention-days: 3
