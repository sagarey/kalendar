name: Android Emulator Testing

on:
  workflow_dispatch:
    inputs:
      branch:
        description: 'Target branch to test'
        required: false
        default: 'main'

env:
  API_LEVEL: 34
  TARGET: default
  ARCH: x86_64
  PROFILE: Nexus 6

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  emulator-test:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    env:
      # ä¼˜åŒ– Gradle æ€§èƒ½ - ubuntu-latest 4æ ¸å¿ƒé…ç½®
      GRADLE_OPTS: -Dorg.gradle.daemon=true -Dorg.gradle.parallel=true -Dorg.gradle.workers.max=4 -Dorg.gradle.configureondemand=true -Dorg.gradle.caching=true -Dkotlin.incremental=true -Dkotlin.incremental.android=true -Dkotlin.compiler.execution.strategy=in-process -Dorg.gradle.jvmargs="-Xmx4g -XX:+UseG1GC -XX:MaxGCPauseMillis=100"
      # Android ç›¸å…³ç¯å¢ƒå˜é‡ - æœ€æ–°é…ç½®
      ANDROID_COMPILE_SDK: 34
      ANDROID_BUILD_TOOLS: 34.0.0
      ANDROID_SDK_TOOLS: 9477386
      ANDROID_HOME: /usr/local/lib/android/sdk
      NDK_HOME: /usr/local/lib/android/sdk/ndk/25.1.8937393

    steps:
      # ============================================
      # é˜¶æ®µ1: ä»£ç è·å–å’Œç¼“å­˜é¢„æ£€
      # ============================================
      
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 1

      # ============================================
      # ç¼“å­˜ç­–ç•¥å†³ç­–ï¼šæ£€æŸ¥ â†’ è¿˜åŸ or åˆå§‹åŒ–
      # ============================================

      - name: Check Cache Availability
        id: check-cache
        run: |
          echo "ğŸ” æ£€æŸ¥ç¼“å­˜å¯ç”¨æ€§..."
          echo ""
          echo "ğŸ“‹ ç¼“å­˜é”®ä¿¡æ¯ (v11ç»Ÿä¸€ç‰ˆæœ¬):"
          echo "  SDKç¼“å­˜é”®: ${{ runner.os }}-android-sdk-${{ env.API_LEVEL }}-v11"
          echo "  AVDç¼“å­˜é”®: ${{ runner.os }}-avd-${{ env.API_LEVEL }}-nexus6-v11"
          echo ""
          echo "ğŸ“ åˆå§‹æœ¬åœ°æ–‡ä»¶æ£€æŸ¥:"
          echo "  SDKç›®å½•: $([ -d "$HOME/.android/sdk" ] && echo 'âœ… å­˜åœ¨' || echo 'âŒ ä¸å­˜åœ¨')"
          echo "  AVDç›®å½•: $([ -d "$HOME/.android/avd" ] && echo 'âœ… å­˜åœ¨' || echo 'âŒ ä¸å­˜åœ¨')"
          echo ""
          echo "ğŸ¯ æ¥ä¸‹æ¥å°†å°è¯•ç¼“å­˜æ¢å¤..."
          echo "âš ï¸  æ³¨æ„: å¦‚æœç¼“å­˜æœªå‘½ä¸­ï¼Œå°†è¿›è¡Œå®Œæ•´çš„SDK/AVDåˆå§‹åŒ–"

      - name: Restore Android SDK Cache
        id: restore-sdk-cache
        uses: actions/cache/restore@v4
        with:
          path: ~/.android/sdk
          key: ${{ runner.os }}-android-sdk-${{ env.API_LEVEL }}-v11

      - name: Restore AVD Cache
        id: restore-avd-cache
        uses: actions/cache/restore@v4
        with:
          path: ~/.android/avd
          key: ${{ runner.os }}-avd-${{ env.API_LEVEL }}-nexus6-v11

      - name: Cache Strategy Decision
        run: |
          echo "ğŸ¯ ç¼“å­˜ç­–ç•¥å†³ç­–ï¼š"
          echo ""
          echo "ğŸ“Š ç¼“å­˜æ¢å¤ç»“æœ:"
          echo "  ğŸ“± Android SDK: ${{ steps.restore-sdk-cache.outputs.cache-hit == 'true' && 'âœ… æˆåŠŸæ¢å¤' || 'âŒ éœ€è¦åˆå§‹åŒ–' }}"
          echo "  ğŸ® AVDé…ç½®: ${{ steps.restore-avd-cache.outputs.cache-hit == 'true' && 'âœ… æˆåŠŸæ¢å¤' || 'âŒ éœ€è¦åˆå§‹åŒ–' }}"
          echo ""
          echo "ğŸ“ æ¢å¤åæ–‡ä»¶æ£€æŸ¥:"
          echo "  SDKç›®å½•: $([ -d "$HOME/.android/sdk" ] && du -sh "$HOME/.android/sdk" 2>/dev/null | cut -f1 || echo 'âŒ ä¸å­˜åœ¨')"
          echo "  AVDç›®å½•: $([ -d "$HOME/.android/avd" ] && du -sh "$HOME/.android/avd" 2>/dev/null | cut -f1 || echo 'âŒ ä¸å­˜åœ¨')"
          echo ""
          echo "ğŸ”„ æ‰§è¡Œç­–ç•¥åˆ†æµ:"
          if [ "${{ steps.restore-sdk-cache.outputs.cache-hit }}" = "true" ] && [ "${{ steps.restore-avd-cache.outputs.cache-hit }}" = "true" ]; then
            echo "  ğŸš€ è·¯å¾„A: åŒç¼“å­˜æ¢å¤æˆåŠŸ â†’ è·³è¿‡åˆå§‹åŒ–ï¼Œç›´æ¥éªŒè¯"
          elif [ "${{ steps.restore-sdk-cache.outputs.cache-hit }}" = "true" ]; then
            echo "  âš¡ è·¯å¾„B: SDKæ¢å¤æˆåŠŸ â†’ è·³è¿‡SDKåˆå§‹åŒ–ï¼Œä»…åˆå§‹åŒ–AVD"
          elif [ "${{ steps.restore-avd-cache.outputs.cache-hit }}" = "true" ]; then
            echo "  ğŸ”§ è·¯å¾„C: AVDæ¢å¤æˆåŠŸ â†’ è·³è¿‡AVDåˆå§‹åŒ–ï¼Œä»…åˆå§‹åŒ–SDK"
          else
            echo "  ğŸ“¥ è·¯å¾„D: å…¨æ–°åˆå§‹åŒ– â†’ å®Œæ•´çš„SDKå’ŒAVDå®‰è£…é…ç½®"
          fi
          echo ""
          echo "ğŸ“‹ è¯¦ç»†çŠ¶æ€å€¼:"
          echo "  SDKæ¢å¤çŠ¶æ€: ${{ steps.restore-sdk-cache.outputs.cache-hit }}"
          echo "  AVDæ¢å¤çŠ¶æ€: ${{ steps.restore-avd-cache.outputs.cache-hit }}"

      # ============================================
      # é˜¶æ®µ2: ç¯å¢ƒè®¾ç½® (åŸºäºç¼“å­˜çŠ¶æ€ä¼˜åŒ–)
      # ============================================

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4
        with:
          cache-read-only: false

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      # ============================================
      # é˜¶æ®µ2: ä¾èµ–ä¸‹è½½å’Œç¯å¢ƒé…ç½®
      # ============================================

      - name: Pre-download dependencies
        timeout-minutes: 5
        run: |
          echo "ğŸ“¥ ä¸‹è½½é¡¹ç›®ä¾èµ–..."
          echo "ğŸ’¾ ç³»ç»Ÿèµ„æº: $(free -h | grep '^Mem:' | awk '{print $2}') å†…å­˜ | $(nproc) CPUæ ¸å¿ƒ"
          ./gradlew dependencies --stacktrace --no-daemon
          echo "âœ… ä¾èµ–ä¸‹è½½å®Œæˆ"

      - name: Setup Android Environment
        run: |
          echo "ğŸš€ é…ç½® Android è¿è¡Œç¯å¢ƒ..."
          
          # å¯ç”¨ KVM ç¡¬ä»¶åŠ é€Ÿ
          echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666", OPTIONS+="static_node=kvm"' | sudo tee /etc/udev/rules.d/99-kvm4all.rules > /dev/null
          sudo udevadm control --reload-rules
          sudo udevadm trigger --name-match=kvm
          
          # æ£€æŸ¥ KVM æ”¯æŒ
          if [ -r /dev/kvm ]; then
            echo "âœ… KVM ç¡¬ä»¶åŠ é€Ÿå·²å¯ç”¨"
          else
            echo "âš ï¸ KVM ç¡¬ä»¶åŠ é€Ÿä¸å¯ç”¨ï¼Œå°†ä½¿ç”¨è½¯ä»¶æ¨¡æ‹Ÿ"
          fi
          
          # è®¾ç½®å›¾å½¢ç¯å¢ƒ
          echo "QT_QPA_PLATFORM=offscreen" >> $GITHUB_ENV
          echo "DISPLAY=:99" >> $GITHUB_ENV
          
          echo "âœ… Android ç¯å¢ƒé…ç½®å®Œæˆ"

      # ============================================
      # é˜¶æ®µ3: AVDç¯å¢ƒå‡†å¤‡ (åŸºäºç¼“å­˜çŠ¶æ€)
      # ============================================

      - name: Prepare AVD Environment
        timeout-minutes: 6
        run: |
          echo "ğŸ”§ å‡†å¤‡ AVD ç¯å¢ƒ..."
          echo "ğŸ” AVDç¼“å­˜çŠ¶æ€: ${{ steps.restore-avd-cache.outputs.cache-hit }}"
          
          # åŸºäºç¼“å­˜çŠ¶æ€å†³å®šæ‰§è¡Œç­–ç•¥
          if [ "${{ steps.restore-avd-cache.outputs.cache-hit }}" = "true" ]; then
            echo "âš¡ AVDç¼“å­˜å‘½ä¸­ï¼ŒéªŒè¯ç°æœ‰é…ç½®..."
            AVD_NAME="test-api${{ env.API_LEVEL }}"
            
            if [ -f "$HOME/.android/avd/${AVD_NAME}.avd/config.ini" ]; then
              echo "âœ… AVDé…ç½®æ–‡ä»¶å­˜åœ¨"
              AVD_SIZE=$(du -sh "$HOME/.android/avd" 2>/dev/null | cut -f1 || echo "unknown")
              echo "ğŸ’¾ AVDç¼“å­˜å¤§å°: $AVD_SIZE"
              
              # éªŒè¯AVDå¯ç”¨æ€§
              if avdmanager list avd | grep -q "$AVD_NAME"; then
                echo "âœ… AVDç¼“å­˜éªŒè¯æˆåŠŸ: $AVD_NAME"
                echo "ğŸš€ è·³è¿‡AVDåˆ›å»ºï¼Œç›´æ¥ä½¿ç”¨ç¼“å­˜"
              else
                echo "âš ï¸ AVDç¼“å­˜æŸåï¼Œé‡æ–°åˆ›å»º..."
                echo "false" > /tmp/cache_valid
              fi
            else
              echo "âš ï¸ AVDé…ç½®æ–‡ä»¶ç¼ºå¤±ï¼Œé‡æ–°åˆ›å»º..."
              echo "false" > /tmp/cache_valid
            fi
          else
            echo "ğŸ“¥ AVDç¼“å­˜æœªå‘½ä¸­ï¼Œå¼€å§‹åˆ›å»º..."
            echo "false" > /tmp/cache_valid
          fi
          
          # å¦‚æœç¼“å­˜æ— æ•ˆæˆ–æœªå‘½ä¸­ï¼Œæ‰§è¡Œå®Œæ•´åˆ›å»ºæµç¨‹
          if [ ! -f /tmp/cache_valid ] || [ "$(cat /tmp/cache_valid 2>/dev/null)" = "false" ]; then
            echo "ğŸ”¨ æ‰§è¡Œå®Œæ•´AVDåˆ›å»ºæµç¨‹..."
            
            # æ£€æŸ¥å¹¶å®‰è£…å¿…è¦çš„system-images
            SYSTEM_IMAGE="system-images;android-${{ env.API_LEVEL }};default;x86_64"
            echo "ğŸ“¦ æ£€æŸ¥ç³»ç»Ÿé•œåƒ: $SYSTEM_IMAGE"
            
            if ! sdkmanager --list_installed | grep -q "$SYSTEM_IMAGE"; then
              echo "ğŸ“¥ ä¸‹è½½ç³»ç»Ÿé•œåƒ..."
              echo "y" | sdkmanager "$SYSTEM_IMAGE"
            else
              echo "âœ… ç³»ç»Ÿé•œåƒå·²å­˜åœ¨"
            fi
            
            # åˆ›å»ºAVD
            AVD_NAME="test-api${{ env.API_LEVEL }}"
            echo "ğŸ“± åˆ›å»ºAVD: $AVD_NAME"
            echo "no" | avdmanager create avd \
              --force \
              --name "$AVD_NAME" \
              --abi "default/x86_64" \
              --package "$SYSTEM_IMAGE" \
              --device "Nexus 6"
            
            # ä¼˜åŒ–AVDé…ç½®
            AVD_CONFIG="$HOME/.android/avd/${AVD_NAME}.avd/config.ini"
            if [ -f "$AVD_CONFIG" ]; then
              echo "âš™ï¸ åº”ç”¨æ€§èƒ½ä¼˜åŒ–é…ç½®..."
              echo "hw.cpu.ncore=2" >> "$AVD_CONFIG"
              echo "hw.ramSize=2048" >> "$AVD_CONFIG"
              echo "hw.gpu.enabled=yes" >> "$AVD_CONFIG"
              echo "hw.gpu.mode=swiftshader_indirect" >> "$AVD_CONFIG"
              echo "âœ… AVDæ€§èƒ½ä¼˜åŒ–å®Œæˆ"
            fi
          fi
          
          # æœ€ç»ˆéªŒè¯
          echo "ğŸ” æœ€ç»ˆAVDéªŒè¯:"
          AVD_NAME="test-api${{ env.API_LEVEL }}"
          if avdmanager list avd | grep -q "$AVD_NAME"; then
            echo "âœ… AVDå‡†å¤‡å®Œæˆ: $AVD_NAME"
          else
            echo "âŒ AVDéªŒè¯å¤±è´¥"
            exit 1
          fi



      # ============================================
      # é˜¶æ®µ4: APK æ„å»º
      # ============================================

      - name: Build APK
        timeout-minutes: 10
        run: |
          echo "ğŸ”¨ æ„å»º APK..."
          
          BUILD_START_TIME=$(date +%s)
          
          # æ„å»ºç¯å¢ƒæ£€æŸ¥
          echo "ğŸ” æ„å»ºç¯å¢ƒ:"
          echo "  å†…å­˜å¯ç”¨: $(free -h | grep '^Mem:' | awk '{print $4}')"
          echo "  ç£ç›˜å¯ç”¨: $(df -h . | tail -1 | awk '{print $4}')"
          echo "  Javaç‰ˆæœ¬: $(java -version 2>&1 | head -1)"
          
          # æ¸…ç†æ„å»ºç¯å¢ƒ
          echo "ğŸ§¹ æ¸…ç†æ„å»ºç¯å¢ƒ..."
          ./gradlew clean --stacktrace
          
          # æ‰§è¡Œæ„å»º
          echo "ğŸ”¨ å¼€å§‹APKæ„å»º..."
          if ./gradlew assembleFossDebug --stacktrace; then
            BUILD_END_TIME=$(date +%s)
            BUILD_DURATION=$((BUILD_END_TIME - BUILD_START_TIME))
            echo "âœ… APKæ„å»ºæˆåŠŸ (${BUILD_DURATION}ç§’)"
            
            # éªŒè¯å›ºå®šçš„APKæ–‡ä»¶
            APK_PATH="app/build/outputs/apk/foss/debug/kalendar-app-foss-debug.apk"
            echo "ğŸ” éªŒè¯APKæ–‡ä»¶: $APK_PATH"
            
            if [ -f "$APK_PATH" ]; then
              APK_SIZE=$(du -h "$APK_PATH" | cut -f1)
              echo "âœ… APKæ„å»ºæˆåŠŸ: $APK_PATH ($APK_SIZE)"
            else
              echo "âŒ é¢„æœŸAPKæ–‡ä»¶æœªæ‰¾åˆ°: $APK_PATH"
              echo "ğŸ” æ£€æŸ¥æ„å»ºè¾“å‡º:"
              find app/build/outputs/apk -name "*.apk" 2>/dev/null | head -5 || echo "æœªæ‰¾åˆ°ä»»ä½•APKæ–‡ä»¶"
              ls -la app/build/outputs/apk/foss/debug/ 2>/dev/null || echo "debugç›®å½•ä¸å­˜åœ¨"
              exit 1
            fi
          else
            echo "âŒ APKæ„å»ºå¤±è´¥"
            exit 1
          fi

      # ============================================
      # é˜¶æ®µ3: æ¨¡æ‹Ÿå™¨æµ‹è¯• + æˆªå›¾
      # ============================================

      - name: Android Emulator Testing with Screenshots
        timeout-minutes: 15
        continue-on-error: false  # ä¸»æµ‹è¯•æ­¥éª¤å¿…é¡»æˆåŠŸ
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: ${{ env.API_LEVEL }}
          target: ${{ env.TARGET }}
          arch: ${{ env.ARCH }}
          profile: ${{ env.PROFILE }}
          avd-name: test-api${{ env.API_LEVEL }}
          force-avd-creation: false
          emulator-options: -no-window -gpu swiftshader_indirect -noaudio -no-boot-anim -camera-back none -camera-front none
          disable-animations: true
          disable-spellchecker: true
          disable-linux-hw-accel: false
          script: |
            set -e  # å¯ç”¨é”™è¯¯é€€å‡ºæ¨¡å¼
            echo "ğŸš€ Androidæ¨¡æ‹Ÿå™¨æµ‹è¯•å¼€å§‹"
            
            # æ£€æŸ¥APKæ–‡ä»¶ - ä½¿ç”¨å›ºå®šè·¯å¾„
            echo "ğŸ” æ£€æŸ¥APKæ–‡ä»¶: app/build/outputs/apk/foss/debug/kalendar-app-foss-debug.apk"
            if [ ! -f "app/build/outputs/apk/foss/debug/kalendar-app-foss-debug.apk" ]; then
              echo "âŒ APKæ–‡ä»¶ä¸å­˜åœ¨"
              echo "ğŸ“ æœç´¢å¯ç”¨çš„APKæ–‡ä»¶:"
              find . -name "*.apk" -type f 2>/dev/null | head -5
              echo "ğŸ“ æ£€æŸ¥æ„å»ºè¾“å‡ºç›®å½•:"
              ls -la app/build/outputs/apk/foss/debug/ 2>/dev/null || echo "æ„å»ºè¾“å‡ºç›®å½•ä¸å­˜åœ¨"
              exit 1
            fi
            
            APK_SIZE=$(du -h "app/build/outputs/apk/foss/debug/kalendar-app-foss-debug.apk" | cut -f1)
            echo "âœ… APKæ–‡ä»¶æ£€æŸ¥é€šè¿‡: $APK_SIZE"
            
            # æ£€æŸ¥è®¾å¤‡è¿æ¥
            echo "ğŸ“± æ£€æŸ¥è®¾å¤‡è¿æ¥"
            adb devices
            adb wait-for-device
            
            # éªŒè¯è®¾å¤‡å¯ç”¨æ€§
            echo "ğŸ” éªŒè¯è®¾å¤‡çŠ¶æ€"
            DEVICE_COUNT=$(adb devices | grep -c "device$" || echo "0")
            if [ "$DEVICE_COUNT" -eq 0 ]; then
              echo "âŒ æ²¡æœ‰å¯ç”¨çš„è®¾å¤‡"
              echo "ğŸ“± è®¾å¤‡åˆ—è¡¨:"
              adb devices
              exit 1
            fi
            echo "âœ… æ‰¾åˆ° $DEVICE_COUNT ä¸ªå¯ç”¨è®¾å¤‡"
            
            # å®‰è£…APK - ä½¿ç”¨å›ºå®šè·¯å¾„
            echo "ğŸ“² å®‰è£…APK: app/build/outputs/apk/foss/debug/kalendar-app-foss-debug.apk"
            if adb install -r app/build/outputs/apk/foss/debug/kalendar-app-foss-debug.apk; then
              echo "âœ… APKå®‰è£…æˆåŠŸ"
            else
              echo "âŒ APKå®‰è£…å¤±è´¥ï¼Œå°è¯•å…¶ä»–æ–¹æ³•"
              echo "ğŸ”„ å¸è½½æ—§ç‰ˆæœ¬åé‡æ–°å®‰è£…"
              adb uninstall org.fossify.calendar 2>/dev/null || echo "æ²¡æœ‰æ—§ç‰ˆæœ¬éœ€è¦å¸è½½"
              if adb install app/build/outputs/apk/foss/debug/kalendar-app-foss-debug.apk; then
                echo "âœ… é‡æ–°å®‰è£…æˆåŠŸ"
              else
                echo "âŒ å®‰è£…å½»åº•å¤±è´¥"
                exit 1
              fi
            fi
            
            # éªŒè¯å®‰è£…
            echo "ğŸ” éªŒè¯åº”ç”¨å®‰è£…"
            if adb shell pm list packages | grep -q "org.fossify.calendar"; then
              echo "âœ… åº”ç”¨å®‰è£…éªŒè¯æˆåŠŸ"
            else
              echo "âŒ åº”ç”¨å®‰è£…éªŒè¯å¤±è´¥"
              exit 1
            fi
            
            # ç­‰å¾…å’Œæˆªå›¾
            echo "â³ ç­‰å¾…ç³»ç»Ÿç¨³å®š"
            sleep 5
            
            echo "ğŸ“¸ è·å–ç³»ç»Ÿæˆªå›¾"
            if adb shell screencap -p /sdcard/screenshot.png; then
              echo "âœ… æˆªå›¾åˆ›å»ºæˆåŠŸ"
              if adb pull /sdcard/screenshot.png calendar_running_screenshot.png; then
                echo "âœ… æˆªå›¾ä¸‹è½½æˆåŠŸ"
              else
                echo "âš ï¸ æˆªå›¾ä¸‹è½½å¤±è´¥"
              fi
            else
              echo "âš ï¸ æˆªå›¾åˆ›å»ºå¤±è´¥"
            fi
            
            echo "âœ… æµ‹è¯•æµç¨‹å®Œæˆ"

      # ============================================
      # é˜¶æ®µ6: ç»“æœæ€»ç»“å’Œæ¸…ç†
      # ============================================

      - name: Test Summary
        if: always()
        run: |
          echo "ğŸ¯ Android CI/CD ç²¾ç®€æµç¨‹æ€»ç»“:"
          echo ""
          echo "ğŸ“Š ä¸‰é˜¶æ®µæ‰§è¡ŒçŠ¶æ€:"
          echo "  1ï¸âƒ£ ç¯å¢ƒå‡†å¤‡+ç¼“å­˜: ${{ job.status == 'success' && 'âœ…' || 'éœ€æ£€æŸ¥' }}"
          echo "  2ï¸âƒ£ APKæ„å»º: ${{ job.status == 'success' && 'âœ…' || 'éœ€æ£€æŸ¥' }}"
          echo "  3ï¸âƒ£ æ¨¡æ‹Ÿå™¨æµ‹è¯•+æˆªå›¾: ${{ job.status == 'success' && 'âœ…' || 'éœ€æ£€æŸ¥' }}"
          echo ""
          echo "ğŸ¯ æ ¸å¿ƒåŠŸèƒ½å®ç°:"
          echo "  ğŸ“¦ APKæ„å»º: kalendar-app-foss-debug.apk"
          echo "  ğŸš€ æ¨¡æ‹Ÿå™¨å¯åŠ¨: Android ${{ env.API_LEVEL }}"
          echo "  ğŸ“² åº”ç”¨å®‰è£…: org.fossify.calendar"
          echo "  ğŸ“¸ è¿è¡Œæˆªå›¾: calendar_running_screenshot.png"
          echo ""
          echo "âš¡ æ€§èƒ½ä¼˜åŒ– (v3.0ç²¾ç®€ç‰ˆ):"
          echo "  ğŸ—‘ï¸ ç§»é™¤å¤æ‚é¢„æ£€æŸ¥å’Œå¿«ç…§é€»è¾‘"
          echo "  ğŸ¯ ä¸“æ³¨æ ¸å¿ƒç›®æ ‡: æ„å»ºâ†’å®‰è£…â†’è¿è¡Œâ†’æˆªå›¾"
          echo "  ğŸ’¾ ä¿ç•™æœ‰æ•ˆç¼“å­˜: SDKå’ŒAVDé…ç½®"
          echo "  ğŸ“¸ æ–°å¢æˆªå›¾åŠŸèƒ½: éªŒè¯åº”ç”¨è¿è¡ŒçŠ¶æ€"
          
          if [ "${{ job.status }}" = "success" ]; then
            echo ""
            echo "ğŸ‰ æµ‹è¯•å®Œæˆï¼Œæˆªå›¾å·²ç”Ÿæˆï¼"
          fi

      # ============================================
      # ç¼“å­˜ä¿å­˜ï¼šä¸ºä¸‹æ¬¡è¿è¡Œå»ºç«‹ç¼“å­˜
      # ============================================

      - name: Save Android SDK Cache
        if: steps.restore-sdk-cache.outputs.cache-hit != 'true'
        uses: actions/cache/save@v4
        with:
          path: ~/.android/sdk
          key: ${{ runner.os }}-android-sdk-${{ env.API_LEVEL }}-v11

      - name: Save AVD Cache
        if: steps.restore-avd-cache.outputs.cache-hit != 'true'
        uses: actions/cache/save@v4
        with:
          path: ~/.android/avd
          key: ${{ runner.os }}-avd-${{ env.API_LEVEL }}-nexus6-v11

      - name: Cache Save Summary
        if: always()
        run: |
          echo "ğŸ’¾ ç¼“å­˜ä¿å­˜æ€»ç»“:"
          echo ""
          echo "ğŸ“Š ä¿å­˜çŠ¶æ€:"
          echo "  ğŸ“± SDKç¼“å­˜: ${{ steps.restore-sdk-cache.outputs.cache-hit != 'true' && 'ğŸ’¾ å·²ä¿å­˜æ–°ç¼“å­˜' || 'âš¡ è·³è¿‡(å·²å­˜åœ¨)' }}"
          echo "  ğŸ® AVDç¼“å­˜: ${{ steps.restore-avd-cache.outputs.cache-hit != 'true' && 'ğŸ’¾ å·²ä¿å­˜æ–°ç¼“å­˜' || 'âš¡ è·³è¿‡(å·²å­˜åœ¨)' }}"
          echo ""
          echo "ğŸš€ ä¸‹æ¬¡è¿è¡Œé¢„æœŸ:"
          if [ "${{ steps.restore-sdk-cache.outputs.cache-hit }}" != "true" ] && [ "${{ steps.restore-avd-cache.outputs.cache-hit }}" != "true" ]; then
            echo "  ğŸ¯ åŒç¼“å­˜å»ºç«‹ â†’ ä¸‹æ¬¡è¿è¡Œå°†æ˜¾è‘—åŠ é€Ÿ"
          elif [ "${{ steps.restore-sdk-cache.outputs.cache-hit }}" != "true" ]; then
            echo "  ğŸ“± SDKç¼“å­˜å»ºç«‹ â†’ ä¸‹æ¬¡è·³è¿‡SDKä¸‹è½½"
          elif [ "${{ steps.restore-avd-cache.outputs.cache-hit }}" != "true" ]; then
            echo "  ğŸ® AVDç¼“å­˜å»ºç«‹ â†’ ä¸‹æ¬¡è·³è¿‡AVDé…ç½®"
          else
            echo "  âœ… ç¼“å­˜å·²å®Œæ•´ â†’ æ€§èƒ½å·²ä¼˜åŒ–"
          fi

      - name: Upload Test Results and Screenshots
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: android-test-results-${{ github.run_number }}
          path: |
            app/build/outputs/apk/foss/debug/kalendar-app-foss-debug.apk
            calendar_running_screenshot.png
            build/reports/**/*
            app/build/reports/**/*
          retention-days: 7
