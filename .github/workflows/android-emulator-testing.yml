name: Android Emulator Testing

on:
  workflow_dispatch:
    inputs:
      branch:
        description: 'Target branch to test'
        required: false
        default: 'main'

env:
  API_LEVEL: 34
  TARGET: default
  ARCH: x86_64
  PROFILE: Nexus 6

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  emulator-test:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    env:
      # ä¼˜åŒ– Gradle æ€§èƒ½ - ubuntu-latest 4æ ¸å¿ƒé…ç½®
      GRADLE_OPTS: -Dorg.gradle.daemon=true -Dorg.gradle.parallel=true -Dorg.gradle.workers.max=4 -Dorg.gradle.configureondemand=true -Dorg.gradle.caching=true -Dkotlin.incremental=true -Dkotlin.incremental.android=true -Dkotlin.compiler.execution.strategy=in-process -Dorg.gradle.jvmargs="-Xmx4g -XX:+UseG1GC -XX:MaxGCPauseMillis=100"
      # Android ç›¸å…³ç¯å¢ƒå˜é‡ - æœ€æ–°é…ç½®
      ANDROID_COMPILE_SDK: 34
      ANDROID_BUILD_TOOLS: 34.0.0
      ANDROID_SDK_TOOLS: 9477386
      ANDROID_HOME: /usr/local/lib/android/sdk
      NDK_HOME: /usr/local/lib/android/sdk/ndk/25.1.8937393

    steps:
      # ============================================
      # é˜¶æ®µ1: ä»£ç è·å–å’Œç¼“å­˜é¢„æ£€
      # ============================================
      
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 1

      # ============================================
      # ç¼“å­˜æ¢å¤
      # ============================================

      - name: Restore SDK Cache
        id: restore-sdk-cache
        uses: actions/cache/restore@v4
        with:
          path: ${{ env.ANDROID_HOME }}
          key: ${{ runner.os }}-sdk-${{ env.API_LEVEL }}-v11

      - name: Restore AVD Cache
        id: restore-avd-cache
        uses: actions/cache/restore@v4
        with:
          path: ~/.android/avd
          key: ${{ runner.os }}-avd-${{ env.API_LEVEL }}-nexus6-v11

      # ============================================
      # é˜¶æ®µ2: åŸºç¡€ç¯å¢ƒè®¾ç½®
      # ============================================

      - name: Setup Java & Gradle
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'
        
      - name: Setup Gradle Cache & Permissions
        run: |
          chmod +x gradlew
        
      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4
        with:
          cache-read-only: false

      # ============================================
      # é˜¶æ®µ3: Android SDK è®¾ç½® (åŸºäºç¼“å­˜ä¼˜åŒ–)
      # ============================================

      - name: Setup SDK
        if: steps.restore-sdk-cache.outputs.cache-hit != 'true'
        uses: android-actions/setup-android@v3
        with:
          packages: |
            platform-tools
            platforms;android-${{ env.API_LEVEL }}
            build-tools;${{ env.ANDROID_BUILD_TOOLS }}

      - name: Save SDK Cache
        if: steps.restore-sdk-cache.outputs.cache-hit != 'true'
        uses: actions/cache/save@v4
        with:
          path: ${{ env.ANDROID_HOME }}
          key: ${{ runner.os }}-sdk-${{ env.API_LEVEL }}-v11

      # ============================================
      # é˜¶æ®µ4: Androidç¯å¢ƒé…ç½®ä¸AVDè®¾ç½®
      # ============================================

      - name: Setup AVD
        timeout-minutes: 6
        run: |
          echo "ğŸ”§ é…ç½®Androidç¯å¢ƒä¸AVD..."
          
          # è®¾ç½®Androidç¯å¢ƒå˜é‡ (æ€»æ˜¯æ‰§è¡Œ)
          echo "ğŸ“± è®¾ç½®Androidç¯å¢ƒå˜é‡..."
          echo "QT_QPA_PLATFORM=offscreen" >> $GITHUB_ENV
          echo "DISPLAY=:99" >> $GITHUB_ENV
          echo "âœ… ç¯å¢ƒå˜é‡è®¾ç½®å®Œæˆ"
          
          # æ£€æŸ¥AVDç¼“å­˜çŠ¶æ€å¹¶æŒ‰éœ€åˆ›å»º
          if [ "${{ steps.restore-avd-cache.outputs.cache-hit }}" != "true" ]; then
            echo "ğŸ”¨ AVDç¼“å­˜æœªå‘½ä¸­ï¼Œå¼€å§‹åˆ›å»ºAVD..."
            
            # æ£€æŸ¥å¹¶å®‰è£…å¿…è¦çš„system-images
            SYSTEM_IMAGE="system-images;android-${{ env.API_LEVEL }};default;x86_64"
            echo "ğŸ“¦ æ£€æŸ¥ç³»ç»Ÿé•œåƒ: $SYSTEM_IMAGE"
            
            if ! sdkmanager --list_installed | grep -q "$SYSTEM_IMAGE"; then
              echo "ğŸ“¥ ä¸‹è½½ç³»ç»Ÿé•œåƒ..."
              echo "y" | sdkmanager "$SYSTEM_IMAGE"
            else
              echo "âœ… ç³»ç»Ÿé•œåƒå·²å­˜åœ¨"
            fi
            
            # åˆ›å»ºAVD
            AVD_NAME="test-api${{ env.API_LEVEL }}"
            echo "ğŸ“± åˆ›å»ºAVD: $AVD_NAME"
            echo "no" | avdmanager create avd \
              --force \
              --name "$AVD_NAME" \
              --abi "default/x86_64" \
              --package "$SYSTEM_IMAGE" \
              --device "Nexus 6"
            
            # ä¼˜åŒ–AVDé…ç½®
            AVD_CONFIG="$HOME/.android/avd/${AVD_NAME}.avd/config.ini"
            if [ -f "$AVD_CONFIG" ]; then
              echo "âš™ï¸ åº”ç”¨æ€§èƒ½ä¼˜åŒ–é…ç½®..."
              echo "hw.cpu.ncore=2" >> "$AVD_CONFIG"
              echo "hw.ramSize=2048" >> "$AVD_CONFIG"
              echo "hw.gpu.enabled=yes" >> "$AVD_CONFIG"
              echo "hw.gpu.mode=swiftshader_indirect" >> "$AVD_CONFIG"
              echo "âœ… AVDæ€§èƒ½ä¼˜åŒ–å®Œæˆ"
            fi
            
            echo "âœ… AVDåˆ›å»ºå®Œæˆ: $AVD_NAME"
          else
            echo "âš¡ AVDç¼“å­˜å‘½ä¸­ï¼Œè·³è¿‡AVDåˆ›å»º"
            AVD_NAME="test-api${{ env.API_LEVEL }}"
            echo "âœ… ä½¿ç”¨ç¼“å­˜çš„AVD: $AVD_NAME"
          fi

      - name: Save AVD Cache
        if: steps.restore-avd-cache.outputs.cache-hit != 'true'
        uses: actions/cache/save@v4
        with:
          path: ~/.android/avd
          key: ${{ runner.os }}-avd-${{ env.API_LEVEL }}-nexus6-v11

      # ============================================
      # é˜¶æ®µ5: APK æ„å»º (åŒ…å«ä¾èµ–ä¸‹è½½)
      # ============================================

      - name: Build APK
        timeout-minutes: 10
        run: |
          echo "ğŸ”¨ æ„å»º APK (åŒ…å«ä¾èµ–ä¸‹è½½)..."
          
          BUILD_START_TIME=$(date +%s)
          
          # ä¸‹è½½ä¾èµ–å¹¶æ„å»º
          echo "ğŸ“¥ ä¸‹è½½ä¾èµ–å¹¶æ¸…ç†æ„å»ºç¯å¢ƒ..."
          ./gradlew dependencies clean --stacktrace --no-daemon
          
          # æ¸…ç†å¯èƒ½æ®‹ç•™çš„APKæ–‡ä»¶
          rm -f app/build/outputs/apk/foss/debug/*.apk 2>/dev/null || true
          
          # æ‰§è¡Œæ„å»º
          echo "ğŸ”¨ å¼€å§‹APKæ„å»º..."
          if ./gradlew assembleFossDebug --stacktrace; then
            BUILD_END_TIME=$(date +%s)
            BUILD_DURATION=$((BUILD_END_TIME - BUILD_START_TIME))
            echo "âœ… APKæ„å»ºæˆåŠŸ (${BUILD_DURATION}ç§’)"
            
            # éªŒè¯APKæ–‡ä»¶
            APK_PATH="app/build/outputs/apk/foss/debug/kalendar-app-foss-debug.apk"
            if [ -f "$APK_PATH" ]; then
              APK_SIZE=$(du -h "$APK_PATH" | cut -f1)
              echo "âœ… APKæ„å»ºæˆåŠŸ: $APK_PATH ($APK_SIZE)"
            else
              echo "âŒ APKæ–‡ä»¶æœªæ‰¾åˆ°: $APK_PATH"
              find app/build/outputs/apk -name "*.apk" 2>/dev/null | head -3 || echo "æœªæ‰¾åˆ°ä»»ä½•APKæ–‡ä»¶"
              exit 1
            fi
          else
            echo "âŒ APKæ„å»ºå¤±è´¥"
            exit 1
          fi

      # ============================================
      # é˜¶æ®µ6: æ¨¡æ‹Ÿå™¨æµ‹è¯• + æˆªå›¾
      # ============================================

      - name: Android Emulator Testing with Screenshots
        timeout-minutes: 15
        continue-on-error: false  # ä¸»æµ‹è¯•æ­¥éª¤å¿…é¡»æˆåŠŸ
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: ${{ env.API_LEVEL }}
          target: ${{ env.TARGET }}
          arch: ${{ env.ARCH }}
          profile: ${{ env.PROFILE }}
          avd-name: test-api${{ env.API_LEVEL }}
          force-avd-creation: false
          emulator-options: -no-window -gpu swiftshader_indirect -noaudio -no-boot-anim -camera-back none -camera-front none
          disable-animations: true
          disable-spellchecker: true
          disable-linux-hw-accel: false
          script: adb uninstall org.fossify.calendar.debug || true && adb install -r app/build/outputs/apk/foss/debug/kalendar-app-foss-debug.apk && adb shell pm list packages | grep org.fossify.calendar.debug && sleep 5 && adb shell screencap -p /sdcard/screenshot.png && adb pull /sdcard/screenshot.png calendar_running_screenshot.png

      # ============================================
      # ç»“æœä¸Šä¼ 
      # ============================================

      - name: Upload Test Results and Screenshots
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: android-test-results-${{ github.run_number }}
          path: |
            app/build/outputs/apk/foss/debug/kalendar-app-foss-debug.apk
            calendar_running_screenshot.png
            build/reports/**/*
            app/build/reports/**/*
          retention-days: 7
