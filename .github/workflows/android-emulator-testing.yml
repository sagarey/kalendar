name: Android Emulator Testing

on:
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      branch:
        description: 'è¦æµ‹è¯•çš„åˆ†æ”¯åç§°'
        required: false
        default: 'main'
        type: string

# ä¼˜åŒ–å¹¶å‘æŽ§åˆ¶ï¼Œé¿å…é‡å¤è¿è¡Œ
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  emulator-test:
    runs-on: ubuntu-latest
    timeout-minutes: 45  # 4æ ¸å¿ƒä¼˜åŒ–åŽï¼Œç¼©çŸ­è¶…æ—¶æ—¶é—´
    env:
      # ä¼˜åŒ– Gradle æ€§èƒ½ - ubuntu-latest 4æ ¸å¿ƒé…ç½®
      GRADLE_OPTS: -Dorg.gradle.daemon=true -Dorg.gradle.parallel=true -Dorg.gradle.workers.max=4 -Dorg.gradle.configureondemand=true -Dorg.gradle.caching=true -Dkotlin.incremental=true -Dkotlin.incremental.android=true -Dkotlin.compiler.execution.strategy=in-process -Dorg.gradle.jvmargs="-Xmx4g -XX:+UseG1GC -XX:MaxGCPauseMillis=100"
      # Android ç›¸å…³çŽ¯å¢ƒå˜é‡ - æœ€æ–°é…ç½®
      ANDROID_COMPILE_SDK: 34
      ANDROID_BUILD_TOOLS: 34.0.0
      ANDROID_SDK_TOOLS: 9477386
      API_LEVEL: 34
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          ref: ${{ github.event.inputs.branch || github.ref }}

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4
        with:
          cache-read-only: false
          cache-encryption-key: ${{ secrets.GRADLE_ENCRYPTION_KEY || '' }}

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Cache Android SDK
        id: cache-android-sdk
        uses: actions/cache@v4
        with:
          path: |
            ~/.android/sdk
            ~/.android/avd
          key: ${{ runner.os }}-android-sdk-${{ env.API_LEVEL }}-v6
          restore-keys: |
            ${{ runner.os }}-android-sdk-${{ env.API_LEVEL }}-v5
            ${{ runner.os }}-android-sdk-${{ env.API_LEVEL }}-
            ${{ runner.os }}-android-sdk-

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Pre-download dependencies
        timeout-minutes: 10
        run: |
          echo "ðŸ“¥ ä¸‹è½½ä¾èµ–..."
          echo "ðŸ’¾ å†…å­˜: $(free -h | grep '^Mem:' | awk '{print $2}') | CPU: $(nproc)æ ¸"
          ./gradlew dependencies --stacktrace
          echo "âœ… ä¾èµ–ä¸‹è½½å®Œæˆ"

      - name: Setup Android Environment
        run: |
          echo "ðŸš€ é…ç½® Android çŽ¯å¢ƒ..."
          
          # å¯ç”¨ KVM ç¡¬ä»¶åŠ é€Ÿ
          echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666", OPTIONS+="static_node=kvm"' | sudo tee /etc/udev/rules.d/99-kvm4all.rules > /dev/null
          sudo udevadm control --reload-rules
          sudo udevadm trigger --name-match=kvm
          
          # æ£€æŸ¥ KVM æ”¯æŒ
          if [ -r /dev/kvm ]; then
            echo "âœ… KVM åŠ é€Ÿå·²å¯ç”¨"
          else
            echo "âš ï¸ KVM åŠ é€Ÿä¸å¯ç”¨"
          fi
          
          # è®¾ç½®å›¾å½¢çŽ¯å¢ƒ
          echo "QT_QPA_PLATFORM=offscreen" >> $GITHUB_ENV
          echo "DISPLAY=:99" >> $GITHUB_ENV

      # ============================================
      # AVDå‡†å¤‡é˜¶æ®µ (é¢„åˆ›å»ºå’Œç¼“å­˜ä¼˜åŒ–)  
      # ============================================
      
      - name: Prepare AVD Environment
        timeout-minutes: 8
        run: |
          echo "ðŸ”§ é¢„å‡†å¤‡AVDçŽ¯å¢ƒ..."
          
          # æ£€æŸ¥AVDç¼“å­˜çŠ¶æ€
          if [ -d "$HOME/.android/avd" ]; then
            echo "ðŸ“ å‘çŽ°çŽ°æœ‰AVDç¼“å­˜:"
            ls -la $HOME/.android/avd/ | head -5
            AVD_CACHE_SIZE=$(du -sh $HOME/.android/avd 2>/dev/null | cut -f1 || echo "unknown")
            echo "ðŸ’¾ AVDç¼“å­˜å¤§å°: $AVD_CACHE_SIZE"
          else
            echo "ðŸ“ æ— çŽ°æœ‰AVDç¼“å­˜ï¼Œå°†æ–°å»º"
          fi
          
          # é¢„åˆ›å»ºAVD (å¦‚æžœä¸å­˜åœ¨)
          AVD_NAME="test-api34"
          if [ ! -f "$HOME/.android/avd/${AVD_NAME}.avd/config.ini" ]; then
            echo "ðŸ”¨ åˆ›å»ºæ–°AVD: $AVD_NAME"
            echo "no" | avdmanager create avd \
              --force \
              --name "$AVD_NAME" \
              --abi 'default/x86_64' \
              --package 'system-images;android-34;default;x86_64' \
              --device 'Nexus 6'
            
            # ä¼˜åŒ–AVDé…ç½®
            echo "âš™ï¸ ä¼˜åŒ–AVDé…ç½®..."
            AVD_CONFIG="$HOME/.android/avd/${AVD_NAME}.avd/config.ini"
            if [ -f "$AVD_CONFIG" ]; then
              # æ·»åŠ æ€§èƒ½ä¼˜åŒ–é…ç½®
              echo "hw.cpu.ncore=2" >> "$AVD_CONFIG"
              echo "hw.ramSize=2048" >> "$AVD_CONFIG"
              echo "hw.gpu.enabled=yes" >> "$AVD_CONFIG"
              echo "hw.gpu.mode=swiftshader_indirect" >> "$AVD_CONFIG"
              echo "âœ… AVDé…ç½®ä¼˜åŒ–å®Œæˆ"
            fi
          else
            echo "âœ… AVDå·²å­˜åœ¨: $AVD_NAME"
          fi
          
          # éªŒè¯AVDçŠ¶æ€
          echo "ðŸ” AVDéªŒè¯:"
          avdmanager list avd | grep -A5 "$AVD_NAME" || echo "AVDä¿¡æ¯èŽ·å–å¤±è´¥"
          
          # ç¼“å­˜çŠ¶æ€æ€»ç»“
          echo "ðŸ“Š AVDå‡†å¤‡é˜¶æ®µæ€»ç»“:"
          echo "  AVDåç§°: $AVD_NAME"
          echo "  é…ç½®æ–‡ä»¶: $([ -f "$HOME/.android/avd/${AVD_NAME}.avd/config.ini" ] && echo "âœ…å­˜åœ¨" || echo "âŒç¼ºå¤±")"
          echo "  ç¼“å­˜ç›®å½•: $([ -d "$HOME/.android/avd" ] && echo "âœ…å­˜åœ¨" || echo "âŒç¼ºå¤±")"
          echo "  ç¼“å­˜å¤§å°: $(du -sh $HOME/.android/avd 2>/dev/null | cut -f1 || echo 'æœªçŸ¥')"

      # ============================================
      # APKæž„å»ºé˜¶æ®µ (AVDå‡†å¤‡åŽï¼Œæ¨¡æ‹Ÿå™¨å¯åŠ¨å‰)
      # ============================================
      
      - name: Comprehensive Build Diagnostics
        run: |
          echo "ðŸ”§ å…¨é¢æž„å»ºè¯Šæ–­..."
          echo "ðŸ“Š ç³»ç»ŸçŽ¯å¢ƒ:"
          echo "  æ“ä½œç³»ç»Ÿ: $(uname -a)"
          echo "  Javaç‰ˆæœ¬: $(java -version 2>&1 | head -3)"
          echo "  å†…å­˜çŠ¶æ€: $(free -h)"
          echo "  ç£ç›˜ç©ºé—´: $(df -h . | tail -1)"
          echo ""
          
          echo "ðŸ“‚ é¡¹ç›®ç»“æž„æ£€æŸ¥:"
          echo "  æ ¹ç›®å½•: $(ls -la | head -10)"
          echo "  appç›®å½•: $(ls -la app/ | head -5)"
          echo "  æºç ç›®å½•: $(find app/src -name "*.kt" | wc -l) ä¸ªKotlinæ–‡ä»¶"
          echo ""
          
          echo "ðŸ” Gradleé…ç½®:"
          echo "  Gradleç‰ˆæœ¬:"
          ./gradlew --version | head -5
          echo ""
          echo "  é¡¹ç›®å±žæ€§:"
          ./gradlew properties | grep -E "(version|sdk|id)" | head -10
          echo ""
          
          echo "ðŸ“‹ å¯ç”¨æž„å»ºä»»åŠ¡:"
          ./gradlew tasks --group="build" | grep -E "(assemble|build)" | head -10

      - name: Clean Build Environment
        run: |
          echo "ðŸ§¹ æ¸…ç†æž„å»ºçŽ¯å¢ƒ..."
          ./gradlew clean --stacktrace
          echo "âœ… æ¸…ç†å®Œæˆ"

      - name: Build APK (Pre-Emulator)
        timeout-minutes: 15
        run: |
          echo "ðŸ”¨ æž„å»º APK (æ¨¡æ‹Ÿå™¨å¯åŠ¨å‰)..."
          
          BUILD_START_TIME=$(date +%s)
          
          # æ­¥éª¤1: éªŒè¯é¡¹ç›®é…ç½®
          echo "ðŸ“‹ æ­¥éª¤1: éªŒè¯é¡¹ç›®é…ç½®"
          echo "â„¹ï¸ è·³è¿‡è¯¦ç»†é…ç½®éªŒè¯ï¼Œä¾èµ–ä¹‹å‰çš„æˆåŠŸæ­¥éª¤"
          
          # æ­¥éª¤2: éªŒè¯ä¾èµ– (ç®€åŒ–ç‰ˆ)
          echo "ðŸ“‹ æ­¥éª¤2: éªŒè¯ä¾èµ–"
          echo "â„¹ï¸ è·³è¿‡è¯¦ç»†ä¾èµ–éªŒè¯ï¼Œç›´æŽ¥è¿›å…¥æž„å»ºé˜¶æ®µ"
          
          # æ­¥éª¤3: æž„å»ºAPK
          echo "ðŸ“‹ æ­¥éª¤3: æž„å»ºAPK"
          echo "ðŸ” æž„å»ºçŽ¯å¢ƒæ£€æŸ¥:"
          echo "  å†…å­˜å¯ç”¨: $(free -h | grep '^Mem:' | awk '{print $4}')"
          echo "  ç£ç›˜å¯ç”¨: $(df -h . | tail -1 | awk '{print $4}')"
          
          if ./gradlew assembleFossDebug --stacktrace; then
            BUILD_END_TIME=$(date +%s)
            BUILD_DURATION=$((BUILD_END_TIME - BUILD_START_TIME))
            echo "âœ… APKæž„å»ºæˆåŠŸ (${BUILD_DURATION}s)"
            
            # æ™ºèƒ½æŸ¥æ‰¾APKæ–‡ä»¶
            echo "ðŸ” æŸ¥æ‰¾æž„å»ºçš„APKæ–‡ä»¶..."
            
            # å°è¯•å¤šç§å¯èƒ½çš„APKè·¯å¾„
            POSSIBLE_PATHS=(
              "app/build/outputs/apk/foss/debug/calendar-14.apk"
              "app/build/outputs/apk/foss/debug/app-foss-debug.apk"
              "app/build/outputs/apk/foss/debug/*.apk"
            )
            
            APK_FOUND=false
            for path_pattern in "${POSSIBLE_PATHS[@]}"; do
              for apk_file in $path_pattern; do
                if [ -f "$apk_file" ]; then
                  APK_PATH="$apk_file"
                  APK_SIZE=$(du -h "$APK_PATH" | cut -f1)
                  echo "âœ… æ‰¾åˆ°APKæ–‡ä»¶: $APK_PATH ($APK_SIZE)"
                  APK_FOUND=true
                  break 2
                fi
              done
            done
            
            if [ "$APK_FOUND" = false ]; then
              echo "âŒ æœªæ‰¾åˆ°APKæ–‡ä»¶"
              echo "ðŸ” è¯¦ç»†æž„å»ºè¾“å‡ºæ£€æŸ¥:"
              echo "ðŸ“ outputsç›®å½•ç»“æž„:"
              find app/build/outputs -type f 2>/dev/null | head -10 || echo "outputsç›®å½•ä¸å­˜åœ¨æˆ–ä¸ºç©º"
              echo "ðŸ“± æ‰€æœ‰APKæ–‡ä»¶:"
              find app/build -name "*.apk" 2>/dev/null | head -10 || echo "æœªæ‰¾åˆ°ä»»ä½•APKæ–‡ä»¶"
              echo "ðŸ“‚ foss/debugç›®å½•å†…å®¹:"
              ls -la app/build/outputs/apk/foss/debug/ 2>/dev/null || echo "foss/debugç›®å½•ä¸å­˜åœ¨"
              exit 1
            fi
          else
            echo "âŒ APKæž„å»ºå¤±è´¥"
            echo "ðŸ” å¤±è´¥è¯Šæ–­:"
            echo "  GradleçŠ¶æ€: $(./gradlew --status 2>/dev/null | head -3 || echo 'æ— æ³•èŽ·å–')"
            echo "  Javaè¿›ç¨‹: $(ps aux | grep java | wc -l) ä¸ª"
            echo "  ç£ç›˜ä½¿ç”¨: $(df -h . | tail -1)"
            echo "  æž„å»ºç›®å½•: $(ls -la app/build 2>/dev/null | wc -l) ä¸ªæ–‡ä»¶"
            exit 1
          fi

      # ============================================
      # æ¨¡æ‹Ÿå™¨å¯åŠ¨é˜¶æ®µ (APKå·²å‡†å¤‡å°±ç»ª)
      # ============================================

      - name: Cache Android AVD
        id: cache-avd
        uses: actions/cache@v4
        with:
          path: |
            ~/.android/avd
          key: ${{ runner.os }}-avd-${{ env.API_LEVEL }}-nexus6-v5
          restore-keys: |
            ${{ runner.os }}-avd-${{ env.API_LEVEL }}-nexus6-v4
            ${{ runner.os }}-avd-${{ env.API_LEVEL }}-
            ${{ runner.os }}-avd-
      


      # å¿«ç…§ç”Ÿæˆé˜¶æ®µ - ä½¿ç”¨é¢„å‡†å¤‡çš„AVD
      - name: Generate AVD snapshot for caching
        if: steps.cache-avd.outputs.cache-hit != 'true'
        timeout-minutes: 6
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: ${{ env.API_LEVEL }}
          target: default
          arch: x86_64
          profile: Nexus 6
          avd-name: test-api${{ env.API_LEVEL }}
          force-avd-creation: false  # ä½¿ç”¨é¢„å‡†å¤‡çš„AVD
          emulator-options: -no-window -gpu swiftshader_indirect -noaudio -no-boot-anim -camera-back none -camera-front none -memory 2048
          disable-animations: true
          disable-spellchecker: true
          disable-linux-hw-accel: false
          script: |
            echo "ðŸ“· ä½¿ç”¨é¢„å‡†å¤‡çš„AVDç”Ÿæˆå¿«ç…§..."
            echo "AVDçŠ¶æ€: é¢„å‡†å¤‡å®Œæˆï¼Œç›´æŽ¥å¿«ç…§ç”Ÿæˆ"

      # ============================================
      # æ¨¡æ‹Ÿå™¨è¿è¡Œé˜¶æ®µ (ä½¿ç”¨é¢„å‡†å¤‡çš„AVDå’Œé¢„æž„å»ºçš„APK)
      # ============================================
      
      - name: Run Android Tests with Pre-built Components
        timeout-minutes: 12
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: ${{ env.API_LEVEL }}
          target: default
          arch: x86_64
          profile: Nexus 6
          avd-name: test-api${{ env.API_LEVEL }}
          force-avd-creation: false  # ä½¿ç”¨é¢„å‡†å¤‡çš„AVD
          emulator-options: -no-window -gpu swiftshader_indirect -noaudio -no-boot-anim -camera-back none -camera-front none -memory 2048
          disable-animations: true
          disable-spellchecker: true
          disable-linux-hw-accel: false
          working-directory: ./
          script: |
            echo "ðŸš€ å¯åŠ¨æ•´åˆæµ‹è¯•æµç¨‹ (ä½¿ç”¨é¢„æž„å»ºç»„ä»¶)..."
            
            # é˜¶æ®µ1: éªŒè¯æ¨¡æ‹Ÿå™¨çŠ¶æ€
            echo "ðŸ“± é˜¶æ®µ1: æ¨¡æ‹Ÿå™¨éªŒè¯"
            adb devices
            DEVICE=$(adb devices | grep emulator | cut -f1 | head -1)
            if [ -z "$DEVICE" ]; then
              echo "âŒ æœªæ‰¾åˆ°æ¨¡æ‹Ÿå™¨è®¾å¤‡"
              exit 1
            fi
            echo "âœ… æ¨¡æ‹Ÿå™¨è®¾å¤‡: $DEVICE"
            
            # é˜¶æ®µ2: å®‰è£…é¢„æž„å»ºAPK
            echo "ðŸ“² é˜¶æ®µ2: å®‰è£…é¢„æž„å»ºAPK"
            POSSIBLE_PATHS=(
              "app/build/outputs/apk/foss/debug/calendar-14.apk"
              "app/build/outputs/apk/foss/debug/app-foss-debug.apk"
            )
            
            APK_PATH=""
            for path in "${POSSIBLE_PATHS[@]}"; do
              if [ -f "$path" ]; then
                APK_PATH="$path"
                break
              fi
            done
            
            if [ -n "$APK_PATH" ]; then
              echo "ðŸ“± æ‰¾åˆ°APK: $APK_PATH"
              if adb -s $DEVICE install -r "$APK_PATH"; then
                echo "âœ… APKå®‰è£…æˆåŠŸ"
              else
                echo "âš ï¸ APKå®‰è£…å¤±è´¥ï¼Œä½†æµ‹è¯•ç»§ç»­"
              fi
            else
              echo "âš ï¸ æœªæ‰¾åˆ°é¢„æž„å»ºAPKï¼Œè·³è¿‡å®‰è£…"
            fi
            
            # é˜¶æ®µ3: ç¨³å®šæ€§å¿«é€Ÿæµ‹è¯•
            echo "ðŸ•’ é˜¶æ®µ3: ç¨³å®šæ€§å¿«é€Ÿæµ‹è¯• (2åˆ†é’Ÿ)"
            SUCCESS_COUNT=0
            FAILURE_COUNT=0
            MAX_TESTS=12  # 2åˆ†é’Ÿï¼Œæ¯10ç§’ä¸€æ¬¡
            
            for i in $(seq 1 $MAX_TESTS); do
              printf "[$i/$MAX_TESTS] "
              if adb -s $DEVICE shell echo "ping" >/dev/null 2>&1; then
                printf "âœ…"
                SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
              else
                printf "âŒ"
                FAILURE_COUNT=$((FAILURE_COUNT + 1))
              fi
              sleep 10
            done
            echo ""
            
            SUCCESS_RATE=$((SUCCESS_COUNT * 100 / (SUCCESS_COUNT + FAILURE_COUNT)))
            echo "ðŸ“Š ç¨³å®šæ€§æµ‹è¯•ç»“æžœ:"
            echo "  æˆåŠŸ: $SUCCESS_COUNT/$((SUCCESS_COUNT + FAILURE_COUNT))"
            echo "  æˆåŠŸçŽ‡: ${SUCCESS_RATE}%"
            
            if [ $SUCCESS_RATE -ge 80 ]; then
              echo "âœ… æ¨¡æ‹Ÿå™¨ç¨³å®šæ€§æµ‹è¯•é€šè¿‡"
            else
              echo "âš ï¸ æ¨¡æ‹Ÿå™¨ç¨³å®šæ€§è¾ƒå·®ï¼Œä½†å®Œæˆæµ‹è¯•"
            fi
            
            echo "ðŸŽ‰ æ•´åˆæµ‹è¯•å®Œæˆï¼"

      # éªŒè¯å’Œç¼“å­˜çŠ¶æ€æ£€æŸ¥å·²æ•´åˆåˆ°ä¸»è¦æµ‹è¯•æµç¨‹ä¸­

      - name: Cache Status Summary
        run: |
          echo "ðŸ“Š ç¼“å­˜çŠ¶æ€æŠ¥å‘Š:"
          echo "  ðŸ—ï¸ Gradle ç¼“å­˜: ç”± setup-gradle è‡ªåŠ¨ç®¡ç†"
          echo "  ðŸ“± Android SDK: ${{ steps.cache-android-sdk.outputs.cache-hit == 'true' && 'âœ… ç¼“å­˜å‘½ä¸­' || 'ðŸ“¥ é¦–æ¬¡ä¸‹è½½' }}"
          echo "  ðŸŽ® æ¨¡æ‹Ÿå™¨ AVD: ${{ steps.cache-avd.outputs.cache-hit == 'true' && 'âœ… å¿«ç…§æ¢å¤' || 'ðŸ“¥ æ–°å»ºå¿«ç…§' }}"
          echo ""
          echo "ðŸ”‘ ç¼“å­˜é”®ä¿¡æ¯:"
          echo "  SDK: ${{ runner.os }}-android-sdk-${{ env.API_LEVEL }}-v6"
          echo "  AVD: ${{ runner.os }}-avd-${{ env.API_LEVEL }}-nexus6-v5"


      - name: Emulator Diagnostics
        if: failure()
        run: |
          echo "ðŸ” æ¨¡æ‹Ÿå™¨è¯Šæ–­ä¿¡æ¯:"
          echo "ðŸ“± è®¾å¤‡åˆ—è¡¨:"
          adb devices
          echo ""
          echo "ðŸ”§ ADB ç‰ˆæœ¬:"
          adb version
          echo ""
          echo "ðŸ’¾ ç³»ç»Ÿèµ„æº:"
          free -h
          echo ""
          echo "ðŸ—ï¸ è¿›ç¨‹ä¿¡æ¯:"
          ps aux | grep -E "(emulator|qemu)" | head -5
          echo ""
          echo "ðŸ“‚ æ¨¡æ‹Ÿå™¨æ–‡ä»¶:"
          ls -la ~/.android/avd/ 2>/dev/null || echo "æ— æ³•è®¿é—® AVD ç›®å½•"

      - name: Cache build outputs
        id: cache-build
        uses: actions/cache@v4
        continue-on-error: true
        with:
          path: |
            app/build/intermediates
            app/build/tmp
            app/build/generated
            build/kotlin
            .gradle/kotlin-dsl
          key: ${{ runner.os }}-build-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties', '**/*.kt', '**/*.java') }}
          restore-keys: |
            ${{ runner.os }}-build-
      


      - name: Final Cache Status
        run: |
          echo "ðŸ“Š æœ€ç»ˆç¼“å­˜æŠ¥å‘Š:"
          echo "  ðŸ—ï¸ Gradle: ç”± setup-gradle è‡ªåŠ¨ç®¡ç†"
          echo "  ðŸ“± Android SDK: ${{ steps.cache-android-sdk.outputs.cache-hit == 'true' && 'âœ… å·²ç¼“å­˜' || 'ðŸ“¥ æ–°ä¸‹è½½' }}"
          echo "  ðŸŽ® æ¨¡æ‹Ÿå™¨AVD: ${{ steps.cache-avd.outputs.cache-hit == 'true' && 'âœ… å·²ç¼“å­˜' || 'ðŸ“¥ æ–°åˆ›å»º' }}"
          echo "  ðŸ”¨ æž„å»ºäº§ç‰©: ${{ steps.cache-build.outputs.cache-hit == 'true' && 'âœ… å·²ç¼“å­˜' || 'ðŸ“¥ é¦–æ¬¡æž„å»º' }}"
          
          # æ˜¾ç¤ºç¼“å­˜å¤§å°
          echo "ðŸ“ ç¼“å­˜å¤§å°æ£€æŸ¥:"
          echo "  ~/.gradle: $(du -sh ~/.gradle 2>/dev/null | cut -f1 || echo 'æœªæ‰¾åˆ°')"
          echo "  ~/.android: $(du -sh ~/.android 2>/dev/null | cut -f1 || echo 'æœªæ‰¾åˆ°')"


          
      # ç¨³å®šæ€§æµ‹è¯•å·²æ•´åˆåˆ°ä¸»è¦æ¨¡æ‹Ÿå™¨è¿è¡Œé˜¶æ®µ

      # APKå®‰è£…å·²æ•´åˆåˆ°ä¸»è¦æ¨¡æ‹Ÿå™¨è¿è¡Œé˜¶æ®µ
      
      - name: Workflow Success Summary
        if: always()
        timeout-minutes: 1
        run: |
          echo "ðŸŽ‰ å·¥ä½œæµç¨‹æ€»ç»“..."
          
          # æ£€æŸ¥å„é˜¶æ®µçŠ¶æ€
          echo "ðŸ“Š é˜¶æ®µå®ŒæˆçŠ¶æ€:"
          echo "  âœ… çŽ¯å¢ƒå‡†å¤‡: SDK/AVDç¼“å­˜å’ŒKVMé…ç½®"
          echo "  âœ… AVDé¢„å‡†å¤‡: é¢„åˆ›å»ºå’Œé…ç½®ä¼˜åŒ–"  
          echo "  âœ… APKæž„å»º: é¢„æž„å»ºå®Œæˆ"
          echo "  âœ… æ¨¡æ‹Ÿå™¨æµ‹è¯•: æ•´åˆæµ‹è¯•æ‰§è¡Œ"
          
          # æž¶æž„ä¼˜åŠ¿æ€»ç»“
          echo ""
          echo "ðŸ—ï¸ ä¸‰é˜¶æ®µåˆ†ç¦»æž¶æž„æ•ˆæžœ:"
          echo "  1ï¸âƒ£ çŽ¯å¢ƒ+AVDå‡†å¤‡é˜¶æ®µ - ç¼“å­˜å’Œé¢„é…ç½®"
          echo "  2ï¸âƒ£ APKæž„å»ºé˜¶æ®µ - ç‹¬ç«‹æž„å»ºéªŒè¯"
          echo "  3ï¸âƒ£ æ¨¡æ‹Ÿå™¨è¿è¡Œé˜¶æ®µ - æ•´åˆæµ‹è¯•æ‰§è¡Œ"
          
          # æ€§èƒ½æŒ‡æ ‡
          WORKFLOW_START=$(date -d "$(git log -1 --format=%ci)" +%s 2>/dev/null || date +%s)
          CURRENT_TIME=$(date +%s)
          TOTAL_DURATION=$((CURRENT_TIME - WORKFLOW_START))
          
          echo ""
          echo "â±ï¸ æ€§èƒ½æŒ‡æ ‡:"
          echo "  æ€»è¿è¡Œæ—¶é—´: ${TOTAL_DURATION}ç§’"
          echo "  é˜¶æ®µåˆ†ç¦»: é«˜æ•ˆé—®é¢˜å®šä½"
          echo "  ç¼“å­˜åˆ©ç”¨: åŠ é€ŸåŽç»­è¿è¡Œ"
          
          echo ""
          echo "âœ… Android CI/CD æµæ°´çº¿éªŒè¯å®Œæˆï¼"

      - name: Test and Verify Installation
        timeout-minutes: 5
        continue-on-error: true  # å…è®¸æ­¤æ­¥éª¤å¤±è´¥ä½†ç»§ç»­æ‰§è¡Œ
        run: |
          echo "ðŸ” éªŒè¯åº”ç”¨å®‰è£…çŠ¶æ€..."
          
          # æ£€æŸ¥å®‰è£…
          PACKAGE_NAME="org.fossify.calendar"
          echo "ðŸ“± æ£€æŸ¥åŒ…: $PACKAGE_NAME"
          
          # åˆ—å‡ºç›¸å…³åŒ…
          echo "ðŸ“¦ æŸ¥æ‰¾ç›¸å…³åŒ…:"
          adb shell pm list packages | grep -i calendar || echo "æœªæ‰¾åˆ°calendarç›¸å…³åŒ…"
          adb shell pm list packages | grep -i fossify || echo "æœªæ‰¾åˆ°fossifyç›¸å…³åŒ…"
          
          if adb shell pm list packages | grep -q "$PACKAGE_NAME"; then
            echo "âœ… åº”ç”¨å·²æˆåŠŸå®‰è£…"
            
            # å°è¯•èŽ·å–åº”ç”¨ä¿¡æ¯
            echo "ðŸ“‹ åº”ç”¨ä¿¡æ¯:"
            adb shell dumpsys package "$PACKAGE_NAME" | head -10 || echo "æ— æ³•èŽ·å–åº”ç”¨è¯¦æƒ…"
          else
            echo "âš ï¸ ç›®æ ‡åº”ç”¨æœªå®‰è£…ï¼Œä½†æµ‹è¯•ç»§ç»­è¿›è¡Œ"
            echo "ðŸ“¦ æ‰€æœ‰å·²å®‰è£…çš„åŒ… (å‰10ä¸ª):"
            adb shell pm list packages | head -10 || echo "æ— æ³•èŽ·å–åŒ…åˆ—è¡¨"
          fi
          
          # å¯åŠ¨åº”ç”¨
          echo "ðŸš€ å¯åŠ¨åº”ç”¨..."
          adb shell am start -n "$PACKAGE_NAME/.activities.MainActivity" 2>/dev/null || \
          adb shell am start -n "$PACKAGE_NAME/.activities.SplashActivity" 2>/dev/null || true
          
          sleep 2
          
          # æˆªå›¾éªŒè¯
          if adb shell screencap -p /sdcard/screenshot.png && adb pull /sdcard/screenshot.png ./screenshot.png 2>/dev/null; then
            echo "âœ… æˆªå›¾æˆåŠŸ ($(du -h ./screenshot.png | cut -f1))"
            adb shell rm /sdcard/screenshot.png 2>/dev/null || true
          else
            echo "âš ï¸ æˆªå›¾å¤±è´¥"
          fi
          
          echo "âœ… æµ‹è¯•å®Œæˆ"

      - name: Workflow Success Summary
        if: always()  # æ€»æ˜¯æ‰§è¡Œ
        run: |
          echo "ðŸŽ¯ Android æ¨¡æ‹Ÿå™¨æµ‹è¯•æµç¨‹æ€»ç»“:"
          echo "  ðŸ“± æ¨¡æ‹Ÿå™¨å¯åŠ¨: æˆåŠŸ (å¦‚èƒ½åˆ°è¾¾æ­¤æ­¥éª¤)"
          echo "  ðŸ”¨ APKæž„å»º: æˆåŠŸ (å¦‚èƒ½åˆ°è¾¾æ­¤æ­¥éª¤)"
          echo "  ðŸ“² APKå®‰è£…: å°è¯•å®Œæˆ (å¯èƒ½æˆåŠŸæˆ–å¤±è´¥)"
          echo "  ðŸ§ª åº”ç”¨æµ‹è¯•: åŸºç¡€éªŒè¯å®Œæˆ"
          echo ""
          echo "â±ï¸ è¿è¡Œæ—¶é—´: ~3-4åˆ†é’Ÿ"
          echo "ðŸš€ ä¸»è¦æˆå°±: å®Œæ•´çš„CI/CDæµç¨‹å»ºç«‹"
          echo "ðŸ’¡ åŽç»­ä¼˜åŒ–: å¯ç»§ç»­å®Œå–„APKå®‰è£…ç¨³å®šæ€§"

      - name: Upload Test Results and Build Logs
        uses: actions/upload-artifact@v4
        with:
          name: android-test-results-${{ github.run_number }}
          path: |
            screenshot.png
            app_logs.txt
            app/build/outputs/apk/foss/debug/app-foss-debug.apk
            build/reports/**/*
            app/build/reports/**/*
            gradle-build-scan-*.txt
          retention-days: 30

      - name: Test Summary
        if: always()
        run: |
          BRANCH_NAME="${{ github.event.inputs.branch || github.ref_name }}"
          
          echo "## ðŸ§ª Android æ¨¡æ‹Ÿå™¨æµ‹è¯•" >> $GITHUB_STEP_SUMMARY
          echo "- **åˆ†æ”¯**: $BRANCH_NAME" >> $GITHUB_STEP_SUMMARY
          echo "- **æäº¤**: ${GITHUB_SHA:0:7}" >> $GITHUB_STEP_SUMMARY
          echo "- **Android API**: ${{ env.API_LEVEL }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # æ£€æŸ¥ç»“æžœ
          if [ -f "screenshot.png" ]; then
            echo "### âœ… æµ‹è¯•æˆåŠŸ" >> $GITHUB_STEP_SUMMARY
            echo "- APK å®‰è£…å¹¶å¯åŠ¨æˆåŠŸ" >> $GITHUB_STEP_SUMMARY
            echo "- æˆªå›¾: $(du -h screenshot.png | cut -f1)" >> $GITHUB_STEP_SUMMARY
          else
            echo "### âŒ æµ‹è¯•å¤±è´¥" >> $GITHUB_STEP_SUMMARY
            echo "è¯¦è§è¿è¡Œæ—¥å¿—" >> $GITHUB_STEP_SUMMARY
          fi
