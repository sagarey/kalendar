name: Android Emulator Testing

on:
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      branch:
        description: 'è¦æµ‹è¯•çš„åˆ†æ”¯åç§°'
        required: false
        default: 'main'
        type: string

# ä¼˜åŒ–å¹¶å‘æŽ§åˆ¶ï¼Œé¿å…é‡å¤è¿è¡Œ
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  emulator-test:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    env:
      # ä¼˜åŒ– Gradle æ€§èƒ½
      GRADLE_OPTS: -Dorg.gradle.daemon=true -Dorg.gradle.parallel=true -Dorg.gradle.configureondemand=true -Dorg.gradle.jvmargs="-Xmx4g -XX:+UseG1GC"
      # Android ç›¸å…³çŽ¯å¢ƒå˜é‡
      ANDROID_COMPILE_SDK: 34
      ANDROID_BUILD_TOOLS: 34.0.0
      ANDROID_SDK_TOOLS: 9477386
      API_LEVEL: 34
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          ref: ${{ github.event.inputs.branch || github.ref }}

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Cache Gradle dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: Setup Gradle
        uses: gradle/gradle-build-action@v3
        with:
          cache-read-only: false

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Pre-download dependencies
        run: |
          echo "ðŸ“¥ ä¸‹è½½ä¾èµ–..."
          ./gradlew dependencies --no-daemon --stacktrace
          echo "âœ… ä¾èµ–ä¸‹è½½å®Œæˆ"

      - name: Cache Android SDK
        uses: actions/cache@v4
        with:
          path: |
            /usr/local/lib/android/sdk
            ~/.android
          key: ${{ runner.os }}-android-sdk-${{ env.API_LEVEL }}
          restore-keys: |
            ${{ runner.os }}-android-sdk-

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Enable KVM and optimize for x86_64
        run: |
          echo "ðŸš€ é…ç½®æ¨¡æ‹Ÿå™¨çŽ¯å¢ƒ..."
          # å¯ç”¨ KVM ç¡¬ä»¶åŠ é€Ÿ
          echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666", OPTIONS+="static_node=kvm"' | sudo tee /etc/udev/rules.d/99-kvm4all.rules
          sudo udevadm control --reload-rules
          sudo udevadm trigger --name-match=kvm
          
          # æ£€æŸ¥ KVM æ”¯æŒ
          if [ -r /dev/kvm ]; then
            echo "âœ… KVM ç¡¬ä»¶åŠ é€Ÿå¯ç”¨"
          else
            echo "âš ï¸ KVM ç¡¬ä»¶åŠ é€Ÿä¸å¯ç”¨"
          fi

      - name: Cache Android Emulator
        uses: actions/cache@v4
        with:
          path: |
            ~/.android/avd/*
            ~/.android/adb*
          key: ${{ runner.os }}-android-emulator-${{ hashFiles('~/.android/avd/**/config.ini') }}
          restore-keys: |
            ${{ runner.os }}-android-emulator-

      - name: Start Android Emulator
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: ${{ env.API_LEVEL }}
          target: google_apis
          arch: x86_64
          profile: Nexus 6
          avd-name: test-device-api${{ env.API_LEVEL }}-x86_64
          force-avd-creation: false
          emulator-options: -no-window -gpu swiftshader_indirect -noaudio -no-boot-anim -camera-back none -camera-front none -qemu -m 2048 -smp 2 -accel kvm
          disable-animations: true
          disable-spellchecker: true
          disable-linux-hw-accel: false
          emulator-build: 7425822
          script: |
            echo "ðŸ“± é…ç½®æ¨¡æ‹Ÿå™¨..."
            adb devices
            
            # å…³é—­åŠ¨ç”»ä»¥åŠ é€Ÿæµ‹è¯•
            adb shell settings put global window_animation_scale 0
            adb shell settings put global transition_animation_scale 0
            adb shell settings put global animator_duration_scale 0
            
            # è®¾ç½®ç³»ç»Ÿè¯­è¨€ä¸ºç®€ä½“ä¸­æ–‡
            adb shell "setprop persist.sys.locale zh-CN && setprop persist.sys.language zh && setprop persist.sys.country CN"
            adb shell "am broadcast -a android.intent.action.LOCALE_CHANGED"
            sleep 2
            
            # éªŒè¯çŽ¯å¢ƒ
            echo "ðŸ¤– Android $(adb shell getprop ro.build.version.release) (API $(adb shell getprop ro.build.version.sdk))"
            echo "ðŸ—ï¸ æž¶æž„: $(adb shell getprop ro.product.cpu.abi)"
            echo "âœ… æ¨¡æ‹Ÿå™¨å°±ç»ª"

      - name: Cache build outputs
        uses: actions/cache@v4
        with:
          path: |
            app/build/intermediates
            app/build/tmp
          key: ${{ runner.os }}-build-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-build-

      - name: Build and Install APK
        run: |
          echo "ðŸ”¨ æž„å»º APK..."
          BUILD_START_TIME=$(date +%s)
          
          if ./gradlew assembleFossDebug --parallel --configure-on-demand --stacktrace --build-cache; then
            BUILD_END_TIME=$(date +%s)
            BUILD_DURATION=$((BUILD_END_TIME - BUILD_START_TIME))
            echo "âœ… æž„å»ºæˆåŠŸ (${BUILD_DURATION}s)"
          else
            echo "âŒ æž„å»ºå¤±è´¥"
            exit 1
          fi
          
          # å®‰è£… APK
          APK_PATH="app/build/outputs/apk/foss/debug/app-foss-debug.apk"
          if [ -f "$APK_PATH" ]; then
            APK_SIZE=$(du -h "$APK_PATH" | cut -f1)
            echo "ðŸ“± APK: $APK_SIZE"
            
            if adb install -r "$APK_PATH"; then
              echo "âœ… å®‰è£…æˆåŠŸ"
            else
              echo "âŒ å®‰è£…å¤±è´¥"
              exit 1
            fi
          else
            echo "âŒ APK æ–‡ä»¶ä¸å­˜åœ¨"
            exit 1
          fi

      - name: Test and Verify Installation
        run: |
          echo "ðŸ” éªŒè¯åº”ç”¨..."
          
          # æ£€æŸ¥å®‰è£…
          PACKAGE_NAME="org.fossify.calendar"
          if adb shell pm list packages | grep -q "$PACKAGE_NAME"; then
            echo "âœ… åº”ç”¨å·²å®‰è£…: $PACKAGE_NAME"
          else
            echo "âŒ åº”ç”¨æœªæ‰¾åˆ°"
            exit 1
          fi
          
          # å°è¯•å¯åŠ¨åº”ç”¨
          echo "ðŸš€ å¯åŠ¨åº”ç”¨..."
          adb shell am start -n "$PACKAGE_NAME/.activities.SplashActivity" || \
          adb shell am start -n "$PACKAGE_NAME/.activities.MainActivity" || \
          echo "âš ï¸ å¯åŠ¨å¤±è´¥"
          
          sleep 3
          
          # æˆªå›¾
          echo "ðŸ“¸ æˆªå›¾..."
          if adb shell screencap -p /sdcard/screenshot.png && adb pull /sdcard/screenshot.png ./screenshot.png; then
            echo "âœ… æˆªå›¾æˆåŠŸ ($(du -h ./screenshot.png | cut -f1))"
            adb shell rm /sdcard/screenshot.png
          else
            echo "âŒ æˆªå›¾å¤±è´¥"
          fi
          
          # æ”¶é›†æ—¥å¿—
          adb logcat -d | grep "$PACKAGE_NAME" | tail -5 > app_logs.txt || true
          if [ -s app_logs.txt ]; then
            echo "âœ… æ”¶é›†åˆ°åº”ç”¨æ—¥å¿—"
          fi

      - name: Upload Test Results and Build Logs
        uses: actions/upload-artifact@v4
        with:
          name: android-test-results-${{ github.run_number }}
          path: |
            screenshot.png
            app_logs.txt
            app/build/outputs/apk/foss/debug/app-foss-debug.apk
            build/reports/**/*
            app/build/reports/**/*
            gradle-build-scan-*.txt
          retention-days: 30

      - name: Test Summary
        if: always()
        run: |
          BRANCH_NAME="${{ github.event.inputs.branch || github.ref_name }}"
          
          echo "## ðŸ§ª Android æ¨¡æ‹Ÿå™¨æµ‹è¯•" >> $GITHUB_STEP_SUMMARY
          echo "- **åˆ†æ”¯**: $BRANCH_NAME" >> $GITHUB_STEP_SUMMARY
          echo "- **æäº¤**: ${GITHUB_SHA:0:7}" >> $GITHUB_STEP_SUMMARY
          echo "- **Android API**: ${{ env.API_LEVEL }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # æ£€æŸ¥ç»“æžœ
          if [ -f "screenshot.png" ]; then
            echo "### âœ… æµ‹è¯•æˆåŠŸ" >> $GITHUB_STEP_SUMMARY
            echo "- APK å®‰è£…å¹¶å¯åŠ¨æˆåŠŸ" >> $GITHUB_STEP_SUMMARY
            echo "- æˆªå›¾: $(du -h screenshot.png | cut -f1)" >> $GITHUB_STEP_SUMMARY
          else
            echo "### âŒ æµ‹è¯•å¤±è´¥" >> $GITHUB_STEP_SUMMARY
            echo "è¯¦è§è¿è¡Œæ—¥å¿—" >> $GITHUB_STEP_SUMMARY
          fi
