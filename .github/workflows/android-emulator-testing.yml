name: Android Emulator Testing

on:
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      branch:
        description: '要测试的分支名称'
        required: false
        default: 'main'
        type: string

# 优化并发控制，避免重复运行
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  emulator-test:
    runs-on: ubuntu-latest
    timeout-minutes: 35  # 4核心优化后，缩短超时时间
    env:
      # 优化 Gradle 性能 - ubuntu-latest 4核心配置
      GRADLE_OPTS: -Dorg.gradle.daemon=true -Dorg.gradle.parallel=true -Dorg.gradle.workers.max=4 -Dorg.gradle.configureondemand=true -Dorg.gradle.caching=true -Dkotlin.incremental=true -Dkotlin.incremental.android=true -Dkotlin.compiler.execution.strategy=in-process -Dorg.gradle.jvmargs="-Xmx4g -XX:+UseG1GC -XX:MaxGCPauseMillis=100"
      # Android 相关环境变量 - 最新配置
      ANDROID_COMPILE_SDK: 34
      ANDROID_BUILD_TOOLS: 34.0.0
      ANDROID_SDK_TOOLS: 9477386
      API_LEVEL: 34
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          ref: ${{ github.event.inputs.branch || github.ref }}

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4
        with:
          cache-read-only: false
          cache-encryption-key: ${{ secrets.GRADLE_ENCRYPTION_KEY || '' }}

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Pre-download dependencies
        timeout-minutes: 10  # 依赖下载超时控制
        run: |
          echo "📥 下载依赖..."
          echo "💾 内存: $(free -h | grep '^Mem:' | awk '{print $2}') | CPU: $(nproc)核"
          ./gradlew dependencies --stacktrace
          echo "✅ 依赖下载完成"

      - name: Cache Android SDK
        id: cache-android-sdk
        uses: actions/cache@v4
        continue-on-error: true
        with:
          path: |
            ~/.android
          key: ${{ runner.os }}-android-sdk-${{ env.API_LEVEL }}-v3
          restore-keys: |
            ${{ runner.os }}-android-sdk-${{ env.API_LEVEL }}-v2
            ${{ runner.os }}-android-sdk-${{ env.API_LEVEL }}-
            ${{ runner.os }}-android-sdk-
      
      - name: Cache Status Summary
        run: |
          echo "📋 缓存状态汇总:"
          # Gradle 缓存 (setup-gradle 内置)
          echo "  🏗️ Gradle: 由 setup-gradle 管理"
          
          # Android SDK 缓存
          if [ "${{ steps.cache-android-sdk.outputs.cache-hit }}" == "true" ]; then
            echo "  ✅ Android SDK: 缓存命中"
          else
            echo "  📥 Android SDK: 需要下载"
          fi
          
          # 显示缓存键信息
          echo "  🔑 SDK 缓存键: ${{ runner.os }}-android-sdk-${{ env.API_LEVEL }}-v3"
          
          # 检查实际路径
          echo "📂 缓存路径检查:"
          echo "  Gradle: $(ls -la ~/.gradle 2>/dev/null | wc -l) 个文件/目录"
          echo "  Android: $(ls -la ~/.android 2>/dev/null | wc -l) 个文件/目录"

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Setup Android Environment
        run: |
          echo "🚀 配置 Android 环境..."
          
          # 启用 KVM 硬件加速
          echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666", OPTIONS+="static_node=kvm"' | sudo tee /etc/udev/rules.d/99-kvm4all.rules > /dev/null
          sudo udevadm control --reload-rules
          sudo udevadm trigger --name-match=kvm
          
          # 检查 KVM 支持
          if [ -r /dev/kvm ]; then
            echo "✅ KVM 加速已启用"
          else
            echo "⚠️ KVM 加速不可用"
          fi
          
          # 启动 ADB 服务
          adb start-server
          
          # 设置图形环境
          echo "QT_QPA_PLATFORM=offscreen" >> $GITHUB_ENV
          echo "DISPLAY=:99" >> $GITHUB_ENV

      - name: Cache Android Emulator
        id: cache-emulator
        uses: actions/cache@v4
        continue-on-error: true
        with:
          path: |
            ~/.android/avd
          key: ${{ runner.os }}-avd-api${{ env.API_LEVEL }}-nexus6-default-v3
          restore-keys: |
            ${{ runner.os }}-avd-api${{ env.API_LEVEL }}-nexus6-default-v2
            ${{ runner.os }}-avd-api${{ env.API_LEVEL }}-nexus6-
            ${{ runner.os }}-avd-api${{ env.API_LEVEL }}-
      


      - name: Start Android Emulator
        timeout-minutes: 10  # 缩短超时时间，快速失败
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: ${{ env.API_LEVEL }}
          target: default
          arch: x86_64
          profile: Nexus 6
          avd-name: test-api${{ env.API_LEVEL }}
          force-avd-creation: false
          emulator-options: -no-window -gpu swiftshader_indirect -noaudio -no-boot-anim -camera-back none -camera-front none -memory 2048
          disable-animations: true
          disable-spellchecker: true
          disable-linux-hw-accel: false
          working-directory: ./
          script: |
            echo "📱 启动模拟器..."
            sleep 15
            
            echo "🔍 检查模拟器状态..."
            adb devices
            
            echo "⏳ 等待 ADB 连接..."
            attempt=1
            while [ $attempt -le 10 ]; do
              echo "连接尝试 $attempt/10..."
              if adb devices | grep -q "emulator.*device"; then
                echo "✅ ADB 已连接"
                break
              fi
              
              if [ $attempt -eq 5 ]; then
                echo "重启 ADB 服务..."
                adb kill-server 2>/dev/null || true
                sleep 2
                adb start-server 2>/dev/null || true
                sleep 3
              fi
              
              sleep 5
              attempt=$((attempt + 1))
            done
            
            DEVICE=$(adb devices | grep emulator | cut -f1 | head -1)
            if [ -z "$DEVICE" ]; then
              echo "❌ 未找到模拟器设备"
              adb devices
              exit 1
            fi
            echo "📱 设备: $DEVICE"
            
            echo "⏳ 等待系统启动..."
            check_count=0
            while [ $check_count -lt 40 ]; do
              boot_status=$(adb -s $DEVICE shell getprop sys.boot_completed 2>/dev/null | tr -d '\r\n')
              if [ "$boot_status" = "1" ]; then
                echo "✅ 系统启动完成"
                break
              fi
              echo "启动检查 $((check_count + 1))/40..."
              sleep 5
              check_count=$((check_count + 1))
            done
            
            if [ $check_count -eq 40 ]; then
              echo "❌ 系统启动超时"
              exit 1
            fi
            
            echo "⚡ 优化性能设置..."
            adb -s $DEVICE shell settings put global window_animation_scale 0 2>/dev/null || true
            adb -s $DEVICE shell settings put global transition_animation_scale 0 2>/dev/null || true
            adb -s $DEVICE shell settings put global animator_duration_scale 0 2>/dev/null || true
            
            echo "✅ 模拟器准备完成"

      - name: Emulator Diagnostics
        if: failure()
        run: |
          echo "🔍 模拟器诊断信息:"
          echo "📱 设备列表:"
          adb devices
          echo ""
          echo "🔧 ADB 版本:"
          adb version
          echo ""
          echo "💾 系统资源:"
          free -h
          echo ""
          echo "🏗️ 进程信息:"
          ps aux | grep -E "(emulator|qemu)" | head -5
          echo ""
          echo "📂 模拟器文件:"
          ls -la ~/.android/avd/ 2>/dev/null || echo "无法访问 AVD 目录"

      - name: Cache build outputs
        id: cache-build
        uses: actions/cache@v4
        continue-on-error: true
        with:
          path: |
            app/build/intermediates
            app/build/tmp
            app/build/generated
            build/kotlin
            .gradle/kotlin-dsl
          key: ${{ runner.os }}-build-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties', '**/*.kt', '**/*.java') }}
          restore-keys: |
            ${{ runner.os }}-build-
      


      - name: Final Cache Status
        run: |
          echo "📊 最终缓存报告:"
          echo "  🏗️ Gradle: 由 setup-gradle 自动管理"
          echo "  📱 Android SDK: ${{ steps.cache-android-sdk.outputs.cache-hit == 'true' && '✅ 已缓存' || '📥 新下载' }}"
          echo "  🎮 模拟器AVD: ${{ steps.cache-emulator.outputs.cache-hit == 'true' && '✅ 已缓存' || '📥 新创建' }}"
          echo "  🔨 构建产物: ${{ steps.cache-build.outputs.cache-hit == 'true' && '✅ 已缓存' || '📥 首次构建' }}"
          
          # 显示缓存大小
          echo "📏 缓存大小检查:"
          echo "  ~/.gradle: $(du -sh ~/.gradle 2>/dev/null | cut -f1 || echo '未找到')"
          echo "  ~/.android: $(du -sh ~/.android 2>/dev/null | cut -f1 || echo '未找到')"

      - name: Build and Install APK
        timeout-minutes: 12  # 构建超时控制
        run: |
          echo "🔨 构建 APK..."
          BUILD_START_TIME=$(date +%s)
          
          if ./gradlew assembleFossDebug --configure-on-demand --stacktrace --build-cache; then
            BUILD_END_TIME=$(date +%s)
            BUILD_DURATION=$((BUILD_END_TIME - BUILD_START_TIME))
            echo "✅ 构建成功 (${BUILD_DURATION}s)"
          else
            echo "❌ 构建失败"
            exit 1
          fi
          
          # 安装 APK
          APK_PATH="app/build/outputs/apk/foss/debug/app-foss-debug.apk"
          if [ -f "$APK_PATH" ]; then
            APK_SIZE=$(du -h "$APK_PATH" | cut -f1)
            echo "📱 安装 APK ($APK_SIZE)..."
            
            if adb install -r -t "$APK_PATH" 2>/dev/null || adb install -r -t "$APK_PATH"; then
              echo "✅ APK 安装成功"
            else
              echo "❌ APK 安装失败"
              exit 1
            fi
          else
            echo "❌ APK 文件不存在"
            exit 1
          fi

      - name: Test and Verify Installation
        timeout-minutes: 5  # 测试验证超时控制
        run: |
          echo "🔍 验证应用..."
          
          # 检查安装
          PACKAGE_NAME="org.fossify.calendar"
          if adb shell pm list packages | grep -q "$PACKAGE_NAME"; then
            echo "✅ 应用已安装"
          else
            echo "❌ 应用未找到"
            exit 1
          fi
          
          # 启动应用
          echo "🚀 启动应用..."
          adb shell am start -n "$PACKAGE_NAME/.activities.MainActivity" 2>/dev/null || \
          adb shell am start -n "$PACKAGE_NAME/.activities.SplashActivity" 2>/dev/null || true
          
          sleep 2
          
          # 截图验证
          if adb shell screencap -p /sdcard/screenshot.png && adb pull /sdcard/screenshot.png ./screenshot.png 2>/dev/null; then
            echo "✅ 截图成功 ($(du -h ./screenshot.png | cut -f1))"
            adb shell rm /sdcard/screenshot.png 2>/dev/null || true
          else
            echo "⚠️ 截图失败"
          fi
          
          echo "✅ 测试完成"

      - name: Upload Test Results and Build Logs
        uses: actions/upload-artifact@v4
        with:
          name: android-test-results-${{ github.run_number }}
          path: |
            screenshot.png
            app_logs.txt
            app/build/outputs/apk/foss/debug/app-foss-debug.apk
            build/reports/**/*
            app/build/reports/**/*
            gradle-build-scan-*.txt
          retention-days: 30

      - name: Test Summary
        if: always()
        run: |
          BRANCH_NAME="${{ github.event.inputs.branch || github.ref_name }}"
          
          echo "## 🧪 Android 模拟器测试" >> $GITHUB_STEP_SUMMARY
          echo "- **分支**: $BRANCH_NAME" >> $GITHUB_STEP_SUMMARY
          echo "- **提交**: ${GITHUB_SHA:0:7}" >> $GITHUB_STEP_SUMMARY
          echo "- **Android API**: ${{ env.API_LEVEL }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # 检查结果
          if [ -f "screenshot.png" ]; then
            echo "### ✅ 测试成功" >> $GITHUB_STEP_SUMMARY
            echo "- APK 安装并启动成功" >> $GITHUB_STEP_SUMMARY
            echo "- 截图: $(du -h screenshot.png | cut -f1)" >> $GITHUB_STEP_SUMMARY
          else
            echo "### ❌ 测试失败" >> $GITHUB_STEP_SUMMARY
            echo "详见运行日志" >> $GITHUB_STEP_SUMMARY
          fi
