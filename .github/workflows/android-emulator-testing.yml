name: Android Emulator Testing

on:
  workflow_dispatch:
    inputs:
      branch:
        description: 'Target branch to test'
        required: false
        default: 'main'

env:
  API_LEVEL: 34
  TARGET: default
  ARCH: x86_64
  PROFILE: Nexus 6

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  emulator-test:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    env:
      # ä¼˜åŒ– Gradle æ€§èƒ½ - ubuntu-latest 4æ ¸å¿ƒ/16GB å†…å­˜é…ç½®
      GRADLE_OPTS: -Dorg.gradle.daemon=true -Dorg.gradle.parallel=true -Dorg.gradle.workers.max=4 -Dorg.gradle.configureondemand=true -Dorg.gradle.caching=true -Dkotlin.incremental=true -Dkotlin.incremental.android=true -Dkotlin.compiler.execution.strategy=in-process -Dorg.gradle.jvmargs="-Xmx4g -XX:+UseG1GC -XX:MaxGCPauseMillis=100"
      # Android ç›¸å…³ç¯å¢ƒå˜é‡ - æœ€æ–°é…ç½®
      ANDROID_COMPILE_SDK: 34
      ANDROID_BUILD_TOOLS: 34.0.0
      ANDROID_SDK_TOOLS: 9477386
      ANDROID_HOME: /usr/local/lib/android/sdk
      NDK_HOME: /usr/local/lib/android/sdk/ndk/25.1.8937393

    steps:
      # ============================================
      # ğŸš€ ç²¾ç®€æµç¨‹ï¼šæ„å»ºAPK â†’ å¯åŠ¨æ¨¡æ‹Ÿå™¨ â†’ å®‰è£…è¿è¡Œ â†’ æˆªå›¾
      # ğŸ”„ æ¯æ¬¡éƒ½é‡æ–°åˆ›å»ºï¼Œç¡®ä¿ç¯å¢ƒä¸€è‡´æ€§
      # ============================================
      
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 1

      - name: Setup Environment
        run: |
          echo "ğŸš€ é…ç½®æ„å»ºå’Œæ¨¡æ‹Ÿå™¨ç¯å¢ƒ..."
          
          # å¯ç”¨ KVM ç¡¬ä»¶åŠ é€Ÿ
          echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666", OPTIONS+="static_node=kvm"' | sudo tee /etc/udev/rules.d/99-kvm4all.rules > /dev/null
          sudo udevadm control --reload-rules
          sudo udevadm trigger --name-match=kvm
          
          # è®¾ç½®å›¾å½¢ç¯å¢ƒ
          echo "QT_QPA_PLATFORM=offscreen" >> $GITHUB_ENV
          echo "DISPLAY=:99" >> $GITHUB_ENV
          
          echo "âœ… KVM: $( [ -r /dev/kvm ] && echo 'å·²å¯ç”¨' || echo 'è½¯ä»¶æ¨¡æ‹Ÿ' )"

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'

      - name: Setup Gradle & Android SDK
        run: |
          chmod +x gradlew

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Setup Gradle Cache
        uses: gradle/actions/setup-gradle@v4
        with:
          cache-read-only: false

      - name: Setup AVD
        timeout-minutes: 6
        run: |
          echo "ğŸ”¨ åˆ›å»º AVD..."
          AVD_NAME="test-api${{ env.API_LEVEL }}"
          
          # å®‰è£…ç³»ç»Ÿé•œåƒå¹¶åˆ›å»ºAVD
          SYSTEM_IMAGE="system-images;android-${{ env.API_LEVEL }};default;x86_64"
          echo "y" | sdkmanager "$SYSTEM_IMAGE"
          echo "no" | avdmanager create avd --force --name "$AVD_NAME" \
            --abi "default/x86_64" --package "$SYSTEM_IMAGE" --device "Nexus 6"
          
          # æŸ¥æ‰¾ config.ini æ–‡ä»¶ä½ç½®
          echo "ğŸ” æŸ¥æ‰¾ config.ini æ–‡ä»¶ä½ç½®..."
          echo "é¢„æœŸä½ç½®: $HOME/.android/avd/${AVD_NAME}.avd/config.ini"
          echo "AVD ç›®å½•ç»“æ„:"
          ls -la "$HOME/.android/avd/" 2>/dev/null || echo "AVD ç›®å½•ä¸å­˜åœ¨"
          if [ -d "$HOME/.android/avd/${AVD_NAME}.avd" ]; then
            echo "AVD é…ç½®ç›®å½•å†…å®¹:"
            ls -la "$HOME/.android/avd/${AVD_NAME}.avd/"
          fi
          echo "å…¨å±€æŸ¥æ‰¾ config.ini æ–‡ä»¶:"
          find "$HOME/.android" -name "config.ini" 2>/dev/null || echo "æœªæ‰¾åˆ° config.ini æ–‡ä»¶"
          
          # ä¼˜åŒ–é…ç½®
          AVD_CONFIG="$HOME/.android/avd/${AVD_NAME}.avd/config.ini"
          echo "hw.cpu.ncore=2" >> "$AVD_CONFIG"
          echo "hw.ramSize=2048" >> "$AVD_CONFIG"
          echo "hw.gpu.enabled=yes" >> "$AVD_CONFIG"
          echo "hw.gpu.mode=swiftshader_indirect" >> "$AVD_CONFIG"
          echo "âœ… AVD åˆ›å»ºå®Œæˆ: $AVD_NAME"

      - name: Build APK
        timeout-minutes: 10
        run: |
          echo "ğŸ”¨ æ„å»º APK..."
          APK_PATH="app/build/outputs/apk/foss/debug/kalendar-app-foss-debug.apk"
          
          # æ¸…ç†å¹¶æ„å»º
          ./gradlew clean assembleFossDebug --stacktrace --no-daemon
          
          # éªŒè¯APK
          if [ -f "$APK_PATH" ]; then
            APK_SIZE=$(du -h "$APK_PATH" | cut -f1)
            echo "âœ… APKæ„å»ºæˆåŠŸ: $APK_SIZE"
          else
            echo "âŒ APKæ„å»ºå¤±è´¥"
            exit 1
          fi

      - name: å¯åŠ¨æ¨¡æ‹Ÿå™¨å¹¶æµ‹è¯•åº”ç”¨
        timeout-minutes: 15
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: ${{ env.API_LEVEL }}
          target: ${{ env.TARGET }}
          arch: ${{ env.ARCH }}
          profile: ${{ env.PROFILE }}
          avd-name: test-api${{ env.API_LEVEL }}
          force-avd-creation: false
          emulator-options: -no-window -gpu swiftshader_indirect -noaudio -no-boot-anim -camera-back none -camera-front none
          disable-animations: true
          disable-spellchecker: true
          disable-linux-hw-accel: false
          script: |
            echo "ğŸ“² å®‰è£…å¹¶è¿è¡Œåº”ç”¨..."
            adb uninstall org.fossify.calendar.debug || true
            adb install -r app/build/outputs/apk/foss/debug/kalendar-app-foss-debug.apk
            adb shell pm list packages | grep org.fossify.calendar.debug
            sleep 5
            echo "ğŸ“¸ æˆªå›¾..."
            adb shell screencap -p /sdcard/screenshot.png
            adb pull /sdcard/screenshot.png calendar_running_screenshot.png
            echo "âœ… æµ‹è¯•å®Œæˆ"

      - name: ä¸Šä¼ æµ‹è¯•ç»“æœ
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: android-test-results-${{ github.run_number }}
          path: |
            app/build/outputs/apk/foss/debug/kalendar-app-foss-debug.apk
            calendar_running_screenshot.png
          retention-days: 7
