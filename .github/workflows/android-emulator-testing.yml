name: Android Emulator Testing

on:
  workflow_dispatch:
    inputs:
      branch:
        description: 'Target branch to test'
        required: false
        default: 'main'

env:
  API_LEVEL: 34
  TARGET: default
  ARCH: x86_64
  PROFILE: Nexus 6

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  emulator-test:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    env:
      # ä¼˜åŒ– Gradle æ€§èƒ½ - ubuntu-latest 4æ ¸å¿ƒé…ç½®
      GRADLE_OPTS: -Dorg.gradle.daemon=true -Dorg.gradle.parallel=true -Dorg.gradle.workers.max=4 -Dorg.gradle.configureondemand=true -Dorg.gradle.caching=true -Dkotlin.incremental=true -Dkotlin.incremental.android=true -Dkotlin.compiler.execution.strategy=in-process -Dorg.gradle.jvmargs="-Xmx4g -XX:+UseG1GC -XX:MaxGCPauseMillis=100"
      # Android ç›¸å…³ç¯å¢ƒå˜é‡ - æœ€æ–°é…ç½®
      ANDROID_COMPILE_SDK: 34
      ANDROID_BUILD_TOOLS: 34.0.0
      ANDROID_SDK_TOOLS: 9477386
      ANDROID_HOME: /usr/local/lib/android/sdk
      NDK_HOME: /usr/local/lib/android/sdk/ndk/25.1.8937393

    steps:
      # ============================================
      # é˜¶æ®µ1: åŸºç¡€ç¯å¢ƒå’Œç¼“å­˜æ¢å¤
      # ============================================
      
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 1

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4
        with:
          cache-read-only: false

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      # ä¼˜å…ˆæ¢å¤ Android SDK ç¼“å­˜ (çº¯SDKï¼Œä¸åŒ…å«AVD)
      - name: Cache Android SDK
        id: cache-android-sdk
        uses: actions/cache@v4
        with:
          path: ~/.android/sdk
          key: ${{ runner.os }}-android-sdk-${{ env.API_LEVEL }}-v8
          restore-keys: |
            ${{ runner.os }}-android-sdk-${{ env.API_LEVEL }}-v7
            ${{ runner.os }}-android-sdk-${{ env.API_LEVEL }}-
            ${{ runner.os }}-android-sdk-

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      # ============================================
      # é˜¶æ®µ2: ä¾èµ–ä¸‹è½½å’Œç¯å¢ƒé…ç½®
      # ============================================

      - name: Pre-download dependencies
        timeout-minutes: 5
        run: |
          echo "ğŸ“¥ ä¸‹è½½é¡¹ç›®ä¾èµ–..."
          echo "ğŸ’¾ ç³»ç»Ÿèµ„æº: $(free -h | grep '^Mem:' | awk '{print $2}') å†…å­˜ | $(nproc) CPUæ ¸å¿ƒ"
          ./gradlew dependencies --stacktrace --no-daemon
          echo "âœ… ä¾èµ–ä¸‹è½½å®Œæˆ"

      - name: Setup Android Environment
        run: |
          echo "ğŸš€ é…ç½® Android è¿è¡Œç¯å¢ƒ..."
          
          # å¯ç”¨ KVM ç¡¬ä»¶åŠ é€Ÿ
          echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666", OPTIONS+="static_node=kvm"' | sudo tee /etc/udev/rules.d/99-kvm4all.rules > /dev/null
          sudo udevadm control --reload-rules
          sudo udevadm trigger --name-match=kvm
          
          # æ£€æŸ¥ KVM æ”¯æŒ
          if [ -r /dev/kvm ]; then
            echo "âœ… KVM ç¡¬ä»¶åŠ é€Ÿå·²å¯ç”¨"
          else
            echo "âš ï¸ KVM ç¡¬ä»¶åŠ é€Ÿä¸å¯ç”¨ï¼Œå°†ä½¿ç”¨è½¯ä»¶æ¨¡æ‹Ÿ"
          fi
          
          # è®¾ç½®å›¾å½¢ç¯å¢ƒ
          echo "QT_QPA_PLATFORM=offscreen" >> $GITHUB_ENV
          echo "DISPLAY=:99" >> $GITHUB_ENV
          
          echo "âœ… Android ç¯å¢ƒé…ç½®å®Œæˆ"

      # ============================================
      # é˜¶æ®µ3: AVD å‡†å¤‡ã€ç¼“å­˜å’Œå¿«ç…§ç”Ÿæˆ
      # ============================================
      
      - name: Cache AVD
        id: cache-avd
        uses: actions/cache@v4
        with:
          path: ~/.android/avd
          key: ${{ runner.os }}-avd-${{ env.API_LEVEL }}-nexus6-v7
          restore-keys: |
            ${{ runner.os }}-avd-${{ env.API_LEVEL }}-nexus6-v6
            ${{ runner.os }}-avd-${{ env.API_LEVEL }}-nexus6-
            ${{ runner.os }}-avd-${{ env.API_LEVEL }}-

      - name: Prepare AVD Environment
        timeout-minutes: 6
        run: |
          echo "ğŸ”§ å‡†å¤‡ AVD ç¯å¢ƒ..."
          
          # æ£€æŸ¥å¹¶å®‰è£…å¿…è¦çš„system-images
          SYSTEM_IMAGE="system-images;android-${{ env.API_LEVEL }};default;x86_64"
          echo "ğŸ“¦ æ£€æŸ¥ç³»ç»Ÿé•œåƒ: $SYSTEM_IMAGE"
          
          # å®‰è£…ç³»ç»Ÿé•œåƒ (å¦‚æœä¸å­˜åœ¨)
          if ! sdkmanager --list_installed | grep -q "$SYSTEM_IMAGE"; then
            echo "ğŸ“¥ ä¸‹è½½ç³»ç»Ÿé•œåƒ..."
            echo "y" | sdkmanager "$SYSTEM_IMAGE"
          else
            echo "âœ… ç³»ç»Ÿé•œåƒå·²å­˜åœ¨"
          fi
          
          # æ£€æŸ¥ç°æœ‰AVDçŠ¶æ€
          AVD_NAME="test-api${{ env.API_LEVEL }}"
          echo "ğŸ“± ç›®æ ‡AVD: $AVD_NAME"
          
          if [ -f "$HOME/.android/avd/${AVD_NAME}.avd/config.ini" ]; then
            echo "âœ… å‘ç°ç°æœ‰AVDç¼“å­˜"
            AVD_SIZE=$(du -sh "$HOME/.android/avd" 2>/dev/null | cut -f1 || echo "unknown")
            echo "ğŸ’¾ AVDç¼“å­˜å¤§å°: $AVD_SIZE"
          else
            echo "ğŸ”¨ åˆ›å»ºæ–°çš„AVD..."
            echo "no" | avdmanager create avd \
              --force \
              --name "$AVD_NAME" \
              --abi "default/x86_64" \
              --package "$SYSTEM_IMAGE" \
              --device "Nexus 6"
            
            # ä¼˜åŒ–AVDé…ç½®
            AVD_CONFIG="$HOME/.android/avd/${AVD_NAME}.avd/config.ini"
            if [ -f "$AVD_CONFIG" ]; then
              echo "âš™ï¸ åº”ç”¨æ€§èƒ½ä¼˜åŒ–é…ç½®..."
              echo "hw.cpu.ncore=2" >> "$AVD_CONFIG"
              echo "hw.ramSize=2048" >> "$AVD_CONFIG"
              echo "hw.gpu.enabled=yes" >> "$AVD_CONFIG"
              echo "hw.gpu.mode=swiftshader_indirect" >> "$AVD_CONFIG"
              echo "âœ… AVDæ€§èƒ½ä¼˜åŒ–å®Œæˆ"
            fi
          fi
          
          # éªŒè¯AVDçŠ¶æ€
          echo "ğŸ” AVDéªŒè¯:"
          if avdmanager list avd | grep -q "$AVD_NAME"; then
            echo "âœ… AVDå‡†å¤‡å®Œæˆ: $AVD_NAME"
          else
            echo "âŒ AVDåˆ›å»ºå¤±è´¥"
            exit 1
          fi

      - name: Complete Cache Status Check
        run: |
          echo "ğŸ“Š å®Œæ•´ç¼“å­˜çŠ¶æ€æ£€æŸ¥ (æ‰€æœ‰ç¼“å­˜æ“ä½œå®Œæˆå):"
          echo "  ğŸ—ï¸ Gradleç¼“å­˜: ç”± setup-gradle è‡ªåŠ¨ç®¡ç†"
          echo "  ğŸ“± Android SDK: ${{ steps.cache-android-sdk.outputs.cache-hit == 'true' && 'âœ… ç¼“å­˜å‘½ä¸­' || 'ğŸ“¥ é¦–æ¬¡ä¸‹è½½' }}"
          echo "  ğŸ® AVDç¼“å­˜: ${{ steps.cache-avd.outputs.cache-hit == 'true' && 'âœ… ç¼“å­˜å‘½ä¸­' || 'ğŸ“¥ é¦–æ¬¡åˆ›å»º' }}"
          echo ""
          echo "ğŸ“ ç¯å¢ƒè·¯å¾„æ£€æŸ¥:"
          echo "  ANDROID_HOME: $ANDROID_HOME"
          echo "  SDKç›®å½•: $([ -d "$ANDROID_HOME" ] && echo "âœ…å­˜åœ¨ ($(du -sh $ANDROID_HOME 2>/dev/null | cut -f1 || echo 'unknown'))" || echo "âŒç¼ºå¤±")"
          echo "  AVDç›®å½•: $([ -d "$HOME/.android/avd" ] && echo "âœ…å­˜åœ¨ ($(du -sh $HOME/.android/avd 2>/dev/null | cut -f1 || echo 'unknown'))" || echo "âŒç¼ºå¤±")"
          echo ""
          echo "ğŸ”‘ ç¼“å­˜é”®ä¿¡æ¯:"
          echo "  SDKé”®: ${{ runner.os }}-android-sdk-${{ env.API_LEVEL }}-v8"
          echo "  AVDé”®: ${{ runner.os }}-avd-${{ env.API_LEVEL }}-nexus6-v7"
          echo ""
          echo "ğŸ“Š ç¼“å­˜æ•ˆæœ:"
          echo "  é¢„è®¡æ€§èƒ½æå‡: ${{ (steps.cache-android-sdk.outputs.cache-hit == 'true' && steps.cache-avd.outputs.cache-hit == 'true') && 'ğŸš€ åŒç¼“å­˜å‘½ä¸­ï¼Œæœ€ä½³æ€§èƒ½' || 'âš¡ éƒ¨åˆ†ç¼“å­˜å‘½ä¸­ï¼Œæ€§èƒ½æå‡' }}"

      - name: Create AVD snapshot for future caching
        if: steps.cache-avd.outputs.cache-hit != 'true'
        timeout-minutes: 5
        continue-on-error: true  # ğŸ”¥ å…³é”®ä¿®å¤ï¼šå¿«ç…§å¤±è´¥ä¸å½±å“æ•´ä½“æµç¨‹
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: ${{ env.API_LEVEL }}
          target: ${{ env.TARGET }}
          arch: ${{ env.ARCH }}
          profile: ${{ env.PROFILE }}
          avd-name: test-api${{ env.API_LEVEL }}
          force-avd-creation: false
          emulator-options: -no-window -gpu swiftshader_indirect -noaudio -no-boot-anim -camera-back none -camera-front none -memory 2048
          disable-animations: true
          disable-spellchecker: true
          disable-linux-hw-accel: false
          script: |
            echo "ğŸ“· å°è¯•åˆ›å»ºAVDå¿«ç…§ç”¨äºæœªæ¥ç¼“å­˜..."
            echo "ğŸ¯ ç›®çš„: ä¸ºåç»­workflowè¿è¡Œå»ºç«‹å¿«é€Ÿå¯åŠ¨å¿«ç…§"
            echo "âš¡ é¢„æœŸæ•ˆæœ: æˆåŠŸæ—¶ä¸‹æ¬¡å¯åŠ¨ä»3-4åˆ†é’Ÿå‡å°‘åˆ°30-60ç§’"
            echo "ğŸ›¡ï¸ å®¹é”™æœºåˆ¶: å¿«ç…§åˆ›å»ºå¤±è´¥ä¸å½±å“æ•´ä½“æµ‹è¯•æµç¨‹"
            echo "âœ… AVDå¿«ç…§å°è¯•å®Œæˆï¼ŒæˆåŠŸæ—¶å°†ä¿å­˜åˆ°ç¼“å­˜"

      # ============================================
      # é˜¶æ®µ4: APK æ„å»º
      # ============================================

      - name: Build APK
        timeout-minutes: 10
        run: |
          echo "ğŸ”¨ æ„å»º APK..."
          
          BUILD_START_TIME=$(date +%s)
          
          # æ„å»ºç¯å¢ƒæ£€æŸ¥
          echo "ğŸ” æ„å»ºç¯å¢ƒ:"
          echo "  å†…å­˜å¯ç”¨: $(free -h | grep '^Mem:' | awk '{print $4}')"
          echo "  ç£ç›˜å¯ç”¨: $(df -h . | tail -1 | awk '{print $4}')"
          echo "  Javaç‰ˆæœ¬: $(java -version 2>&1 | head -1)"
          
          # æ¸…ç†æ„å»ºç¯å¢ƒ
          echo "ğŸ§¹ æ¸…ç†æ„å»ºç¯å¢ƒ..."
          ./gradlew clean --stacktrace
          
          # æ‰§è¡Œæ„å»º
          echo "ğŸ”¨ å¼€å§‹APKæ„å»º..."
          if ./gradlew assembleFossDebug --stacktrace; then
            BUILD_END_TIME=$(date +%s)
            BUILD_DURATION=$((BUILD_END_TIME - BUILD_START_TIME))
            echo "âœ… APKæ„å»ºæˆåŠŸ (${BUILD_DURATION}ç§’)"
            
            # éªŒè¯å›ºå®šçš„APKæ–‡ä»¶
            APK_PATH="app/build/outputs/apk/foss/debug/kalendar-app-foss-debug.apk"
            echo "ğŸ” éªŒè¯APKæ–‡ä»¶: $APK_PATH"
            
            if [ -f "$APK_PATH" ]; then
              APK_SIZE=$(du -h "$APK_PATH" | cut -f1)
              echo "âœ… APKæ„å»ºæˆåŠŸ: $APK_PATH ($APK_SIZE)"
            else
              echo "âŒ é¢„æœŸAPKæ–‡ä»¶æœªæ‰¾åˆ°: $APK_PATH"
              echo "ğŸ” æ£€æŸ¥æ„å»ºè¾“å‡º:"
              find app/build/outputs/apk -name "*.apk" 2>/dev/null | head -5 || echo "æœªæ‰¾åˆ°ä»»ä½•APKæ–‡ä»¶"
              ls -la app/build/outputs/apk/foss/debug/ 2>/dev/null || echo "debugç›®å½•ä¸å­˜åœ¨"
              exit 1
            fi
          else
            echo "âŒ APKæ„å»ºå¤±è´¥"
            exit 1
          fi

      # ============================================
      # é˜¶æ®µ5: æ¨¡æ‹Ÿå™¨æµ‹è¯• (ä½¿ç”¨é¢„å‡†å¤‡çš„å¿«ç…§)
      # ============================================

      - name: Pre-Test Environment Check
        run: |
          echo "ğŸ” æµ‹è¯•å‰ç¯å¢ƒæ£€æŸ¥..."
          
          echo "ğŸ“Š ç³»ç»Ÿèµ„æº:"
          echo "  å†…å­˜: $(free -h | grep '^Mem:' | awk '{print $2" æ€»é‡, "$4" å¯ç”¨"}')"
          echo "  CPU: $(nproc) æ ¸å¿ƒ"
          echo "  ç£ç›˜: $(df -h . | tail -1 | awk '{print $4" å¯ç”¨"}')"
          
          echo "ğŸ“± AVDçŠ¶æ€:"
          AVD_NAME="test-api${{ env.API_LEVEL }}"
          if [ -f "$HOME/.android/avd/${AVD_NAME}.avd/config.ini" ]; then
            echo "  âœ… AVDé…ç½®å­˜åœ¨"
            if [ -d "$HOME/.android/avd/${AVD_NAME}.avd/snapshots" ]; then
              SNAPSHOT_COUNT=$(find "$HOME/.android/avd/${AVD_NAME}.avd/snapshots" -name "*.snapshot" 2>/dev/null | wc -l)
              echo "  ğŸ“· å¿«ç…§æ–‡ä»¶: $SNAPSHOT_COUNT ä¸ª"
            else
              echo "  ğŸ“· å¿«ç…§æ–‡ä»¶: æ—  (é¦–æ¬¡å¯åŠ¨ä¼šè¾ƒæ…¢)"
            fi
          else
            echo "  âŒ AVDé…ç½®ç¼ºå¤±"
            exit 1
          fi
          
          echo "ğŸ“¦ APKçŠ¶æ€:"
          APK_PATH="app/build/outputs/apk/foss/debug/kalendar-app-foss-debug.apk"
          if [ -f "$APK_PATH" ]; then
            APK_SIZE=$(du -h "$APK_PATH" | cut -f1)
            echo "  âœ… APKå‡†å¤‡å°±ç»ª: $APK_SIZE"
          else
            echo "  âŒ APKæ–‡ä»¶ç¼ºå¤±: $APK_PATH"
            exit 1
          fi
          
          echo "ğŸš€ é¢„æ£€æŸ¥å®Œæˆï¼Œå¼€å§‹æ¨¡æ‹Ÿå™¨æµ‹è¯•..."

      - name: Run Integrated Tests
        timeout-minutes: 15
        continue-on-error: false  # ä¸»æµ‹è¯•æ­¥éª¤å¿…é¡»æˆåŠŸ
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: ${{ env.API_LEVEL }}
          target: ${{ env.TARGET }}
          arch: ${{ env.ARCH }}
          profile: ${{ env.PROFILE }}
          avd-name: test-api${{ env.API_LEVEL }}
          force-avd-creation: false
          emulator-options: -no-window -gpu swiftshader_indirect -noaudio -no-boot-anim -camera-back none -camera-front none -memory 2048
          disable-animations: true
          disable-spellchecker: true
          disable-linux-hw-accel: false
          script: |
            set -e  # å¯ç”¨é”™è¯¯é€€å‡º
            echo "ğŸš€ å¼€å§‹æ•´åˆæµ‹è¯•..."
            
            # è¯¦ç»†çš„ç¯å¢ƒè¯Šæ–­
            echo "ğŸ” ç¯å¢ƒè¯Šæ–­:"
            echo "  Shell: $0"
            echo "  PWD: $(pwd)"
            echo "  ç”¨æˆ·: $(whoami)"
            
            # éªŒè¯æ¨¡æ‹Ÿå™¨
            echo "ğŸ“± æ¨¡æ‹Ÿå™¨éªŒè¯:"
            echo "ğŸ” ADBçŠ¶æ€:"
            adb devices || {
              echo "âŒ ADB deviceså‘½ä»¤å¤±è´¥"
              adb start-server
              sleep 2
              adb devices
            }
            
            echo "ğŸ” è¯¦ç»†è®¾å¤‡ä¿¡æ¯:"
            adb devices -l 2>/dev/null || echo "è¯¦ç»†è®¾å¤‡ä¿¡æ¯è·å–å¤±è´¥"
            
            DEVICE=$(adb devices | grep emulator | cut -f1 | head -1)
            echo "ğŸ” æå–çš„è®¾å¤‡: '$DEVICE'"
            
            if [ -z "$DEVICE" ]; then
              echo "âŒ æœªæ‰¾åˆ°æ¨¡æ‹Ÿå™¨è®¾å¤‡"
              echo "ğŸ” å®Œæ•´adb devicesè¾“å‡º:"
              adb devices
              echo "ğŸ” è¿›ç¨‹æ£€æŸ¥:"
              ps aux | grep emulator | head -5 || echo "æœªæ‰¾åˆ°emulatorè¿›ç¨‹"
              exit 1
            fi
            echo "âœ… æ¨¡æ‹Ÿå™¨è®¾å¤‡: $DEVICE"
            
            # å®‰è£…å›ºå®šè·¯å¾„çš„APK
            APK_PATH="app/build/outputs/apk/foss/debug/kalendar-app-foss-debug.apk"
            echo "ğŸ“² å®‰è£…APK: $APK_PATH"
            
            echo "ğŸ” APKè·¯å¾„æ£€æŸ¥:"
            echo "  å½“å‰ç›®å½•: $(pwd)"
            echo "  APKè·¯å¾„: $APK_PATH"
            echo "  æ–‡ä»¶å­˜åœ¨: $([ -f "$APK_PATH" ] && echo "âœ… æ˜¯" || echo "âŒ å¦")"
            
            if [ -f "$APK_PATH" ]; then
              APK_SIZE=$(du -h "$APK_PATH" | cut -f1)
              echo "ğŸ“± æ‰¾åˆ°APK: $APK_SIZE"
              
              echo "ğŸ” è®¾å¤‡è¿æ¥æµ‹è¯•:"
              if adb -s $DEVICE shell echo "è¿æ¥æµ‹è¯•" >/dev/null 2>&1; then
                echo "âœ… è®¾å¤‡è¿æ¥æ­£å¸¸"
              else
                echo "âŒ è®¾å¤‡è¿æ¥å¼‚å¸¸"
                exit 1
              fi
              
              echo "ğŸ“² æ‰§è¡ŒAPKå®‰è£…..."
              if adb -s $DEVICE install -r "$APK_PATH"; then
                echo "âœ… APKå®‰è£…æˆåŠŸ"
                
                # éªŒè¯å®‰è£…
                echo "ğŸ” éªŒè¯åº”ç”¨å®‰è£…:"
                if adb -s $DEVICE shell pm list packages | grep -q "org.fossify.calendar"; then
                  echo "âœ… åº”ç”¨å®‰è£…éªŒè¯æˆåŠŸ"
                else
                  echo "âš ï¸ å®‰è£…éªŒè¯å¤±è´¥"
                fi
              else
                echo "âš ï¸ APKå®‰è£…å¤±è´¥ï¼Œä½†æµ‹è¯•ç»§ç»­"
              fi
            else
              echo "âŒ é¢„æœŸAPKæ–‡ä»¶ä¸å­˜åœ¨: $APK_PATH"
              echo "ğŸ” æœç´¢å¯èƒ½çš„APKæ–‡ä»¶:"
              find . -name "*.apk" 2>/dev/null | head -5 || echo "æœªæ‰¾åˆ°ä»»ä½•APKæ–‡ä»¶"
              echo "âŒ æ— æ³•ç»§ç»­æµ‹è¯•"
              exit 1
            fi
            
            # ç¨³å®šæ€§æµ‹è¯• (2åˆ†é’Ÿ) - ä½¿ç”¨POSIXå…¼å®¹è¯­æ³•
            echo "ğŸ•’ ç¨³å®šæ€§æµ‹è¯• (2åˆ†é’Ÿ):"
            SUCCESS_COUNT=0
            TOTAL_TESTS=12
            
            echo "ğŸ” å¼€å§‹è¿ç»­æ€§æµ‹è¯•..."
            i=1
            while [ $i -le $TOTAL_TESTS ]; do
              printf "[$i/$TOTAL_TESTS] "
              
              if adb -s "$DEVICE" shell echo "test" >/dev/null 2>&1; then
                printf "âœ…"
                SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
              else
                printf "âŒ"
                echo ""
                echo "ğŸ” ç¬¬${i}æ¬¡æµ‹è¯•å¤±è´¥ï¼Œæ£€æŸ¥è®¾å¤‡çŠ¶æ€:"
                adb -s "$DEVICE" shell getprop sys.boot_completed 2>/dev/null || echo "æ— æ³•è·å–å¯åŠ¨çŠ¶æ€"
              fi
              
              sleep 10
              i=$((i + 1))
            done
            echo ""
            
            # å®‰å…¨çš„é™¤æ³•è®¡ç®—
            if [ $TOTAL_TESTS -gt 0 ]; then
              SUCCESS_RATE=$((SUCCESS_COUNT * 100 / TOTAL_TESTS))
            else
              SUCCESS_RATE=0
            fi
            
            echo "ğŸ“Š ç¨³å®šæ€§ç»“æœ: $SUCCESS_COUNT/$TOTAL_TESTS (${SUCCESS_RATE}%)"
            
            if [ $SUCCESS_RATE -ge 80 ]; then
              echo "âœ… æ¨¡æ‹Ÿå™¨ç¨³å®šæ€§æµ‹è¯•é€šè¿‡"
            else
              echo "âš ï¸ æ¨¡æ‹Ÿå™¨ç¨³å®šæ€§è¾ƒå·®ï¼Œä½†ä¸å½±å“æ•´ä½“æµ‹è¯•ç»“æœ"
            fi
            
            echo "ğŸ‰ æ•´åˆæµ‹è¯•å®Œæˆï¼"

      # ============================================
      # é˜¶æ®µ6: ç»“æœæ€»ç»“å’Œæ¸…ç†
      # ============================================

      - name: Test Summary
        if: always()
        run: |
          echo "ğŸ¯ Android CI/CD æµç¨‹æ€»ç»“:"
          echo ""
          echo "ğŸ“Š äº”é˜¶æ®µæ‰§è¡ŒçŠ¶æ€:"
          echo "  1ï¸âƒ£ åŸºç¡€ç¯å¢ƒ+ç¼“å­˜æ¢å¤: âœ…"
          echo "  2ï¸âƒ£ ä¾èµ–ä¸‹è½½+ç¯å¢ƒé…ç½®: âœ…" 
          echo "  3ï¸âƒ£ AVDå‡†å¤‡+å¿«ç…§ç”Ÿæˆ: ${{ job.status == 'success' && 'âœ…' || 'éœ€æ£€æŸ¥' }}"
          echo "  4ï¸âƒ£ APKç‹¬ç«‹æ„å»º: ${{ job.status == 'success' && 'âœ…' || 'éœ€æ£€æŸ¥' }}"
          echo "  5ï¸âƒ£ æ¨¡æ‹Ÿå™¨æ•´åˆæµ‹è¯•: ${{ job.status == 'success' && 'âœ…' || 'éœ€æ£€æŸ¥' }}"
          echo ""
          echo "ğŸ—ï¸ æµç¨‹æ¶æ„ä¼˜åŠ¿ (v2.0ä¼˜åŒ–ç‰ˆ):"
          echo "  âš¡ åˆ†ç¦»å¼ç¼“å­˜: SDK/AVDç‹¬ç«‹ç¼“å­˜ç®¡ç†"
          echo "  ğŸ” é˜¶æ®µåˆ†ç¦»: ç²¾ç¡®é—®é¢˜å®šä½" 
          echo "  ğŸ“ˆ ç¨³å®šæ€§: é¢„æ„å»º+é¢„é…ç½®+å›ºå®šAPK"
          echo "  ğŸ›¡ï¸ å®¹é”™æ€§: æ™ºèƒ½é‡è¯•æœºåˆ¶"
          echo "  â±ï¸ æ€§èƒ½ä¼˜åŒ–: 30åˆ†é’Ÿæ€»è¶…æ—¶(40â†’30åˆ†é’Ÿ)"
          
          if [ "${{ job.status }}" = "success" ]; then
            echo ""
            echo "ğŸ‰ æ‰€æœ‰é˜¶æ®µå‡æˆåŠŸå®Œæˆï¼"
          fi

      - name: Upload Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: android-test-results-${{ github.run_number }}
          path: |
            app/build/outputs/apk/foss/debug/kalendar-app-foss-debug.apk
            build/reports/**/*
            app/build/reports/**/*
          retention-days: 7
